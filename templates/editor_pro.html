<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TF Visualizer Pro - Multi-Cloud Infrastructure Designer</title>

  <!-- Authentication Check - Redirect if not logged in -->
  <script>
    // Check if user is authenticated by calling the API
    fetch('/api/auth/me', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        // Not authenticated - redirect to login
        window.location.href = '/login?redirect=/editor';
      }
      return response.json();
    })
    .then(data => {
      if (!data.success) {
        window.location.href = '/login?redirect=/editor';
      }
      // Check subscription status
      if (data.user && !['active', 'trialing'].includes(data.user.subscription_status)) {
        window.location.href = '/pricing';
      }
    })
    .catch(error => {
      // Error checking auth - redirect to login
      console.error('Auth check failed:', error);
      window.location.href = '/login?redirect=/editor';
    });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f3e7ff 0%, #e0f2fe 100%);
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 24px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .title-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 {
      font-size: 32px;
      font-weight: bold;
      color: #1f2937;
    }

    .cost-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #d1fae5;
      padding: 8px 16px;
      border-radius: 8px;
    }

    .cost-amount {
      font-size: 20px;
      font-weight: bold;
      color: #059669;
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: #7c3aed;
      color: white;
    }

    .btn-primary:hover {
      background: #6d28d9;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-active {
      background: #3b82f6;
      color: white;
    }

    .grid {
      display: grid;
      grid-template-columns: 250px 1fr 350px;
      gap: 24px;
    }

    .palette {
      overflow-y: auto;
    }

    .palette h2 {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
    }

    .category {
      margin-bottom: 16px;
    }

    .category h3 {
      font-size: 14px;
      font-weight: bold;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .resource-item {
      padding: 12px;
      border-radius: 8px;
      color: white;
      cursor: grab;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      user-select: none;
    }

    .resource-item:active {
      cursor: grabbing;
    }

    .resource-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .resource-icon {
      font-size: 24px;
      margin-right: 8px;
    }

    .resource-name {
      font-weight: bold;
      font-size: 14px;
    }

    .resource-type {
      font-size: 11px;
      opacity: 0.9;
    }

    .canvas-section {
      display: flex;
      flex-direction: column;
    }

    .canvas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .canvas-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }

    .connection-banner {
      background: #dbeafe;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      display: none;
      justify-content: space-between;
      align-items: center;
    }

    .connection-banner.active {
      display: flex;
    }

    .canvas-viewport {
      width: 100%;
      height: 1000px;
      background: #f3f4f6;
      border: 4px solid #a78bfa;
      border-radius: 12px;
      overflow: auto;
      position: relative;
    }

    .canvas {
      width: 100%;
      height: 1200px;
      background: white;
      border: 4px solid #c4b5fd;
      border-right: 6px solid #8b5cf6;
      position: relative;
      background-image: 
        linear-gradient(to right, #e5e7eb 1px, transparent 1px),
        linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .canvas.connection-mode {
      border-color: #8b5cf6;
      border-right-color: #6d28d9;
      border-style: dashed;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
    }

    .canvas-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
      background: rgba(245, 243, 255, 0.3);
    }

    .canvas-placeholder .inner {
      background: white;
      border: 2px dashed #c4b5fd;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .resource-card {
      position: absolute;
      width: 200px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      cursor: grab;
      user-select: none;
    }

    .resource-card:active {
      cursor: grabbing;
    }

    .resource-card.selected {
      box-shadow: 0 0 0 4px #7c3aed, 0 8px 24px rgba(0,0,0,0.25);
    }

    .resource-card.connection-start {
      box-shadow: 0 0 0 4px #3b82f6, 0 8px 24px rgba(0,0,0,0.25);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .resource-card-header {
      padding: 12px;
      border-radius: 8px 8px 0 0;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .resource-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .resource-card-name {
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .resource-card-actions {
      display: flex;
      gap: 4px;
    }

    .icon-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
    }

    .icon-btn:hover {
      opacity: 0.8;
    }

    .resource-card-body {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 8px 8px;
      background: white;
    }

    .resource-detail {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .resource-cost {
      font-size: 14px;
      font-weight: bold;
      color: #059669;
      margin-top: 8px;
    }

    .code-section {
      display: flex;
      flex-direction: column;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .code-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }

    .code-output {
      background: #1f2937;
      color: #10b981;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-y: auto;
      max-height: 1200px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #1f2937;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #7c3aed;
    }

    .form-input:disabled {
      background: #f3f4f6;
      color: #6b7280;
      cursor: not-allowed;
    }

    .form-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .ghost-preview {
      position: fixed;
      width: 200px;
      pointer-events: none;
      opacity: 0.7;
      z-index: 999;
      display: none;
    }

    .ghost-preview.active {
      display: block;
    }

    .tips {
      background: #faf5ff;
      border: 1px solid #e9d5ff;
      border-radius: 8px;
      padding: 16px;
    }

    .tips h3 {
      font-size: 14px;
      font-weight: bold;
      color: #581c87;
      margin-bottom: 8px;
    }

    .tips ul {
      list-style: none;
      font-size: 13px;
      color: #6d28d9;
    }

    .tips li {
      margin-bottom: 4px;
    }

    /* Color classes */
    .bg-blue-500 { background: #3b82f6; }
    .bg-blue-600 { background: #2563eb; }
    .bg-blue-700 { background: #1d4ed8; }
    .bg-blue-800 { background: #1e40af; }
    .bg-blue-900 { background: #1e3a8a; }
    .bg-purple-500 { background: #8b5cf6; }
    .bg-purple-600 { background: #7c3aed; }
    .bg-purple-700 { background: #6d28d9; }
    .bg-purple-800 { background: #5b21b6; }
    .bg-purple-900 { background: #4c1d95; }
    .bg-green-500 { background: #10b981; }
    .bg-green-600 { background: #059669; }
    .bg-green-700 { background: #047857; }
    .bg-green-800 { background: #065f46; }
    .bg-orange-500 { background: #f97316; }
    .bg-orange-600 { background: #ea580c; }
    .bg-orange-700 { background: #c2410c; }
    .bg-orange-800 { background: #9a3412; }
    .bg-orange-900 { background: #7c2d12; }
    .bg-pink-500 { background: #ec4899; }
    .bg-pink-600 { background: #db2777; }
    .bg-red-500 { background: #ef4444; }
    .bg-red-600 { background: #dc2626; }
    .bg-teal-500 { background: #14b8a6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title-section">
          <span style="font-size: 32px;">üåê</span>
          <div>
            <h1>TF Visualizer <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 6px; font-size: 16px; vertical-align: middle;">PRO</span></h1>
            <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">Multi-Cloud Infrastructure Designer</div>
          </div>
        </div>
        <div style="display: flex; gap: 16px; align-items: center;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 12px; color: #6b7280; font-weight: 600;">Cloud Provider</label>
            <select id="cloudProviderSelect" class="form-select" style="min-width: 150px;" onchange="switchCloudProvider()">
              <option value="aws">AWS</option>
              <option value="gcp">Google Cloud (GCP)</option>
              <option value="azure">Microsoft Azure</option>
              <option value="digitalocean">DigitalOcean</option>
              <option value="kubernetes">Kubernetes</option>
            </select>
          </div>
          <div class="cost-badge">
            <span style="font-size: 20px;">üí≤</span>
            <span class="cost-amount" id="totalCost">$0.00/mo</span>
          </div>
          <div class="zoom-controls">
            <button class="btn btn-secondary" onclick="zoomOut()">‚àí</button>
            <span id="zoomLevel" style="font-family: monospace; min-width: 50px; text-align: center;">100%</span>
            <button class="btn btn-secondary" onclick="zoomIn()">+</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Left: Resource Palette -->
        <div class="palette">
          <h2>üì¶ Available Resources</h2>
          <div id="resourcePalette"></div>
          <div style="margin-top: 12px; font-size: 11px; color: #6b7280;">
            üí° Click and drag resources onto canvas
          </div>
        </div>

        <!-- Middle: Canvas -->
        <div class="canvas-section">
          <div class="canvas-header">
            <h2>üé® Infrastructure Canvas <span id="resourceCount" style="font-size: 14px; font-weight: normal; color: #6b7280;">(0 resources)</span></h2>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" id="saveBtn" onclick="saveProjectState()">
                üíæ Save
              </button>
              <button class="btn btn-secondary" id="loadBtn" onclick="loadProjectState()">
                üìÇ Load
              </button>
              <button class="btn btn-secondary" id="versionsBtn" onclick="showVersionHistory()" style="display: none;">
                üìú History
              </button>
              <button class="btn btn-secondary" id="connectBtn" onclick="toggleConnectionMode()">
                üîó Connect
              </button>
              <button class="btn" onclick="showAIDesigner()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                ‚ú® AI Designer
              </button>
              <button class="btn" onclick="analyzeCosts()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                üí∞ Optimize Costs
              </button>
              <button class="btn btn-danger" onclick="clearAll()" style="display: none;" id="clearBtn">
                üóëÔ∏è Clear All
              </button>
            </div>
          </div>

          <div class="connection-banner" id="connectionBanner">
            <p style="font-size: 14px; font-weight: 600; color: #1e40af;" id="connectionMessage">
              üîó Connection Mode Active: Click a resource to start
            </p>
            <button class="btn btn-primary" style="font-size: 12px; padding: 4px 12px;" onclick="cancelConnection()">
              Cancel
            </button>
          </div>

          <div class="canvas-viewport">
            <div class="canvas" id="canvas">
              <div class="canvas-placeholder" id="placeholder">
                <div class="inner">
                  <div style="font-size: 64px; margin-bottom: 16px;">üåê</div>
                  <p style="font-size: 20px; font-weight: bold; color: #7c3aed; margin-bottom: 8px;">Drop Zone</p>
                  <p style="font-size: 14px; color: #6b7280;">Click and drag resources from the left panel</p>
                  <p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Release here to add them to your infrastructure</p>
                </div>
              </div>
              <svg id="connectionsSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                <defs>
                  <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#8b5cf6" />
                  </marker>
                </defs>
              </svg>
            </div>
          </div>

          <div class="tips" style="margin-top: 12px;">
            <p style="font-size: 12px; color: #7c3aed; margin-bottom: 8px;">
              <strong>üí° Tips:</strong> Drag resources, modules, or data sources onto canvas ‚Ä¢ Click "Connect" to link resources
            </p>
            <p style="font-size: 12px; color: #6d28d9;">
              <strong>üîó Smart Connections:</strong> VPC‚ÜíSubnet, Data VPC‚ÜíSubnet, Module outputs, and more
            </p>
          </div>
        </div>

        <!-- Right: Generated Code -->
        <div class="code-section">
          <div class="code-header">
            <h2>üíª Terraform Code</h2>
            <div style="display: flex; gap: 8px;">
              <label class="btn btn-secondary" style="font-size: 12px; padding: 4px 12px; cursor: pointer;">
                üì§ Import .tf
                <input type="file" accept=".tf,.hcl" onchange="importTerraformFile(event)" style="display: none;" id="tfImportInput">
              </label>
              <button class="btn btn-primary" style="font-size: 12px; padding: 4px 12px; display: none;" id="exportBtn" onclick="exportCode()">
                ‚¨á Export
              </button>
            </div>
          </div>
          <div class="code-output" id="codeOutput">
            <div style="color: #6b7280; text-align: center; margin-top: 32px;">
              Generated Terraform code will appear here
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card tips">
      <h3 style="font-size: 16px; font-weight: bold; color: #1e40af; margin-bottom: 12px;">üí° How to Use</h3>
      <ul style="font-size: 14px; color: #3730a3; line-height: 1.8;">
        <li>‚Ä¢ <strong>Add Resources:</strong> Click and hold any resource from the left, then drag it onto the canvas</li>
        <li>‚Ä¢ <strong>Modules:</strong> Drag module blocks to represent reusable Terraform modules with source and version</li>
        <li>‚Ä¢ <strong>Data Sources:</strong> Use data blocks to reference existing infrastructure (AMIs, VPCs, etc.)</li>
        <li>‚Ä¢ <strong>Connect Resources:</strong> Click "Connect" button, then click first resource, then second resource to draw a connection</li>
        <li>‚Ä¢ <strong>Edit:</strong> Click the edit icon (‚úèÔ∏è) on any resource to modify its properties, module source, or data filters</li>
        <li>‚Ä¢ <strong>Delete:</strong> Click the trash icon (üóëÔ∏è) on any resource card to remove it</li>
        <li>‚Ä¢ <strong>Import/Export:</strong> Import existing .tf files or export your visual design to Terraform code</li>
      </ul>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Edit Resource</h3>
        <button class="icon-btn" style="color: #6b7280; font-size: 24px;" onclick="closeEditModal()">√ó</button>
      </div>
      <div id="editForm"></div>
    </div>
  </div>

  <!-- Version History Modal -->
  <div class="modal" id="versionModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">üìú Version History</h3>
        <button class="icon-btn" style="color: #6b7280; font-size: 24px;" onclick="closeVersionModal()">√ó</button>
      </div>
      <div style="padding: 20px;">
        <p style="color: #6b7280; margin-bottom: 16px;">Select a version to load:</p>
        <div id="versionList" style="max-height: 400px; overflow-y: auto;">
          <!-- Version list will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- AI Designer Modal -->
  <div class="modal" id="aiDesignerModal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <h2 style="margin-bottom: 20px; color: #667eea;">‚ú® AI Design Assistant</h2>
      <p style="color: #718096; margin-bottom: 20px;">Describe your infrastructure in natural language, and AI will generate a Terraform design for you.</p>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">What do you want to build?</label>
        <textarea
          id="aiPromptInput"
          placeholder="Example: Create a 3-tier web application with load balancer, auto-scaling web servers, and a managed database"
          style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;"
        ></textarea>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Target Cloud Provider</label>
        <select
          id="aiProviderSelect"
          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
        >
          <option value="aws">Amazon Web Services (AWS)</option>
          <option value="gcp">Google Cloud Platform (GCP)</option>
          <option value="azure">Microsoft Azure</option>
          <option value="digitalocean">DigitalOcean</option>
          <option value="kubernetes">Kubernetes</option>
        </select>
      </div>

      <div id="aiDesignResult" style="display: none; margin-top: 20px; padding: 16px; background: #f7fafc; border-radius: 8px; max-height: 400px; overflow-y: auto;">
        <h3 style="margin-bottom: 12px; color: #2d3748;">Generated Design</h3>
        <pre id="aiDesignContent" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6; color: #4a5568;"></pre>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button class="btn btn-primary" onclick="generateAIDesign()" id="generateDesignBtn">
          Generate Design
        </button>
        <button class="btn btn-primary" onclick="applyAIDesignToCanvas()" id="applyDesignBtn" style="display: none; background: #48bb78;">
          ‚úì Apply to Canvas
        </button>
        <button class="btn" onclick="closeAIDesignerModal()" style="background: #e2e8f0; color: #4a5568;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Cost Optimization Modal -->
  <div class="modal" id="costOptimizationModal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <h2 style="margin-bottom: 20px; color: #f5576c;">üí∞ Cost Optimization Analysis</h2>
      <p style="color: #718096; margin-bottom: 20px;">AI will analyze your current infrastructure and suggest cost-saving opportunities.</p>

      <div id="costAnalysisLoading" style="display: none; text-align: center; padding: 40px;">
        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #f5576c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 16px; color: #718096;">Analyzing your infrastructure...</p>
      </div>

      <div id="costAnalysisResult" style="display: none; margin-top: 20px;">
        <div style="padding: 16px; background: #f7fafc; border-radius: 8px; margin-bottom: 16px;">
          <p style="margin-bottom: 8px;"><strong>Current Monthly Cost:</strong> <span id="currentCost" style="color: #e53e3e; font-size: 20px;">$0.00</span></p>
          <p><strong>Resources Analyzed:</strong> <span id="resourceCount">0</span></p>
        </div>

        <div style="max-height: 500px; overflow-y: auto; padding: 16px; background: #f7fafc; border-radius: 8px;">
          <pre id="costOptimizationContent" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6; color: #4a5568;"></pre>
        </div>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button class="btn" onclick="closeCostOptimizationModal()" style="background: #e2e8f0; color: #4a5568;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Ghost Preview -->
  <div class="ghost-preview" id="ghostPreview"></div>

  <script>
    // State
    let resources = [];
    let connections = [];
    let positions = {};
    let nextId = 1;
    let zoom = 1;
    let connectionMode = false;
    let connectionStart = null;
    let draggingId = null;
    let draggingFromPalette = null;
    let dragOffset = { x: 0, y: 0 };
    let selectedResource = null;
    let currentCloudProvider = 'aws';

    // Multi-Cloud Pricing (monthly estimates)
    const pricing = {
      // AWS
      aws_instance: { t2_micro: 8.47, t2_small: 16.79, t2_medium: 33.58, t3_micro: 7.59, t3_small: 15.18, t3_medium: 30.37, m5_large: 70.08, m5_xlarge: 140.16 },
      aws_rds_instance: { db_t2_micro: 15.33, db_t3_micro: 14.02, db_t3_small: 28.47, db_m5_large: 140.16 },
      aws_s3_bucket: 0.023,
      aws_ebs_volume: 0.10,
      aws_vpc: 0,
      aws_subnet: 0,
      aws_security_group: 0,
      aws_lb: 16.20,
      aws_nat_gateway: 32.85,
      aws_lambda_function: 0.20,
      aws_dynamodb_table: 25,
      aws_elasticache_cluster: 12.40,

      // GCP
      google_compute_instance: { e2_micro: 6.11, e2_small: 12.23, e2_medium: 24.46, n1_standard_1: 24.27, n1_standard_2: 48.54, n1_standard_4: 97.09 },
      google_sql_database_instance: { db_f1_micro: 7.67, db_g1_small: 25.00, db_n1_standard_1: 51.76, db_n1_standard_2: 103.52 },
      google_storage_bucket: 0.020,
      google_compute_disk: 0.04,
      google_compute_network: 0,
      google_compute_subnetwork: 0,
      google_compute_firewall: 0,
      google_compute_forwarding_rule: 18.25,
      google_cloud_run_service: 0.50,
      google_cloudfunctions_function: 0.40,
      google_bigtable_instance: 65,
      google_redis_instance: 11.50,

      // Azure
      azurerm_virtual_machine: { Standard_B1s: 7.59, Standard_B2s: 30.37, Standard_B2ms: 60.74, Standard_D2s_v3: 70.08, Standard_D4s_v3: 140.16 },
      azurerm_mssql_database: { Basic: 4.90, S0: 15, S1: 30, S2: 60 },
      azurerm_storage_account: 0.023,
      azurerm_managed_disk: 0.05,
      azurerm_virtual_network: 0,
      azurerm_subnet: 0,
      azurerm_network_security_group: 0,
      azurerm_lb: 18.25,
      azurerm_nat_gateway: 38.69,
      azurerm_function_app: 0.20,
      azurerm_cosmosdb_account: 23.36,
      azurerm_redis_cache: 15.77,

      // DigitalOcean
      digitalocean_droplet: { 's-1vcpu-1gb': 6, 's-2vcpu-2gb': 18, 's-2vcpu-4gb': 24, 's-4vcpu-8gb': 48, 's-8vcpu-16gb': 96 },
      digitalocean_database_cluster: { 'db-s-1vcpu-1gb': 15, 'db-s-2vcpu-4gb': 60, 'db-s-4vcpu-8gb': 120, 'db-s-8vcpu-16gb': 240 },
      digitalocean_spaces_bucket: 5,
      digitalocean_volume: 0.10,
      digitalocean_vpc: 0,
      digitalocean_firewall: 0,
      digitalocean_loadbalancer: 12,
      digitalocean_domain: 0,
      digitalocean_record: 0,
      digitalocean_cdn: 0,
      digitalocean_project: 0,
      digitalocean_ssh_key: 0,
      digitalocean_floating_ip: 6,
      digitalocean_certificate: 0,
      digitalocean_kubernetes_cluster: 12,
      digitalocean_app: 5,
      digitalocean_database_db: 0,
      digitalocean_database_user: 0
    };

    // Resource Templates by Cloud Provider
    const cloudResourceTemplates = {
      aws: {
        Compute: [
          { type: 'aws_instance', name: 'EC2 Instance', icon: 'üñ•Ô∏è', color: 'bg-blue-500', defaultInstance: 't3_medium' },
          { type: 'aws_lambda_function', name: 'Lambda Function', icon: 'Œª', color: 'bg-blue-600' }
        ],
        Database: [
          { type: 'aws_rds_instance', name: 'RDS Database', icon: 'üóÑÔ∏è', color: 'bg-purple-500', defaultInstance: 'db_t3_small' },
          { type: 'aws_dynamodb_table', name: 'DynamoDB Table', icon: 'üìä', color: 'bg-purple-600' },
          { type: 'aws_elasticache_cluster', name: 'ElastiCache', icon: '‚ö°', color: 'bg-purple-700' }
        ],
        Storage: [
          { type: 'aws_s3_bucket', name: 'S3 Bucket', icon: 'üì¶', color: 'bg-green-500' },
          { type: 'aws_ebs_volume', name: 'EBS Volume', icon: 'üíæ', color: 'bg-green-600', defaultSize: 100 }
        ],
        Network: [
          { type: 'aws_vpc', name: 'VPC', icon: 'üåê', color: 'bg-orange-500' },
          { type: 'aws_subnet', name: 'Subnet', icon: 'üîå', color: 'bg-orange-600' },
          { type: 'aws_security_group', name: 'Security Group', icon: 'üîí', color: 'bg-orange-700' },
          { type: 'aws_lb', name: 'Load Balancer', icon: '‚öñÔ∏è', color: 'bg-orange-800' },
          { type: 'aws_nat_gateway', name: 'NAT Gateway', icon: 'üö™', color: 'bg-orange-900' }
        ]
      },
      gcp: {
        Compute: [
          { type: 'google_compute_instance', name: 'Compute Engine VM', icon: 'üñ•Ô∏è', color: 'bg-blue-500', defaultInstance: 'e2_medium' },
          { type: 'google_cloudfunctions_function', name: 'Cloud Functions', icon: 'Œª', color: 'bg-blue-600' },
          { type: 'google_cloud_run_service', name: 'Cloud Run', icon: 'üèÉ', color: 'bg-blue-700' }
        ],
        Database: [
          { type: 'google_sql_database_instance', name: 'Cloud SQL', icon: 'üóÑÔ∏è', color: 'bg-purple-500', defaultInstance: 'db_g1_small' },
          { type: 'google_bigtable_instance', name: 'Cloud Bigtable', icon: 'üìä', color: 'bg-purple-600' },
          { type: 'google_redis_instance', name: 'Memorystore Redis', icon: '‚ö°', color: 'bg-purple-700' }
        ],
        Storage: [
          { type: 'google_storage_bucket', name: 'Cloud Storage', icon: 'üì¶', color: 'bg-green-500' },
          { type: 'google_compute_disk', name: 'Persistent Disk', icon: 'üíæ', color: 'bg-green-600', defaultSize: 100 }
        ],
        Network: [
          { type: 'google_compute_network', name: 'VPC Network', icon: 'üåê', color: 'bg-orange-500' },
          { type: 'google_compute_subnetwork', name: 'Subnetwork', icon: 'üîå', color: 'bg-orange-600' },
          { type: 'google_compute_firewall', name: 'Firewall Rule', icon: 'üîí', color: 'bg-orange-700' },
          { type: 'google_compute_forwarding_rule', name: 'Load Balancer', icon: '‚öñÔ∏è', color: 'bg-orange-800' }
        ]
      },
      azure: {
        Compute: [
          { type: 'azurerm_virtual_machine', name: 'Virtual Machine', icon: 'üñ•Ô∏è', color: 'bg-blue-500', defaultInstance: 'Standard_B2s' },
          { type: 'azurerm_function_app', name: 'Azure Functions', icon: 'Œª', color: 'bg-blue-600' }
        ],
        Database: [
          { type: 'azurerm_mssql_database', name: 'SQL Database', icon: 'üóÑÔ∏è', color: 'bg-purple-500', defaultInstance: 'S0' },
          { type: 'azurerm_cosmosdb_account', name: 'Cosmos DB', icon: 'üìä', color: 'bg-purple-600' },
          { type: 'azurerm_redis_cache', name: 'Redis Cache', icon: '‚ö°', color: 'bg-purple-700' }
        ],
        Storage: [
          { type: 'azurerm_storage_account', name: 'Storage Account', icon: 'üì¶', color: 'bg-green-500' },
          { type: 'azurerm_managed_disk', name: 'Managed Disk', icon: 'üíæ', color: 'bg-green-600', defaultSize: 100 }
        ],
        Network: [
          { type: 'azurerm_virtual_network', name: 'Virtual Network', icon: 'üåê', color: 'bg-orange-500' },
          { type: 'azurerm_subnet', name: 'Subnet', icon: 'üîå', color: 'bg-orange-600' },
          { type: 'azurerm_network_security_group', name: 'Network Security Group', icon: 'üîí', color: 'bg-orange-700' },
          { type: 'azurerm_lb', name: 'Load Balancer', icon: '‚öñÔ∏è', color: 'bg-orange-800' },
          { type: 'azurerm_nat_gateway', name: 'NAT Gateway', icon: 'üö™', color: 'bg-orange-900' }
        ]
      },
      digitalocean: {
        Compute: [
          { type: 'digitalocean_droplet', name: 'Droplet', icon: 'üíß', color: 'bg-blue-500', defaultInstance: 's-2vcpu-4gb' },
          { type: 'digitalocean_kubernetes_cluster', name: 'Kubernetes', icon: '‚ò∏Ô∏è', color: 'bg-blue-600' },
          { type: 'digitalocean_app', name: 'App Platform', icon: 'üì±', color: 'bg-blue-700' }
        ],
        Database: [
          { type: 'digitalocean_database_cluster', name: 'Managed Database', icon: 'üóÑÔ∏è', color: 'bg-purple-500', defaultInstance: 'db-s-2vcpu-4gb' },
          { type: 'digitalocean_database_db', name: 'Database', icon: 'üìä', color: 'bg-purple-600' },
          { type: 'digitalocean_database_user', name: 'Database User', icon: 'üë§', color: 'bg-purple-700' }
        ],
        Storage: [
          { type: 'digitalocean_spaces_bucket', name: 'Spaces Bucket', icon: 'üì¶', color: 'bg-green-500' },
          { type: 'digitalocean_volume', name: 'Block Storage', icon: 'üíæ', color: 'bg-green-600', defaultSize: 100 },
          { type: 'digitalocean_cdn', name: 'CDN', icon: 'üåç', color: 'bg-teal-500' }
        ],
        Network: [
          { type: 'digitalocean_vpc', name: 'VPC', icon: 'üåê', color: 'bg-orange-500' },
          { type: 'digitalocean_firewall', name: 'Firewall', icon: 'üîí', color: 'bg-orange-600' },
          { type: 'digitalocean_loadbalancer', name: 'Load Balancer', icon: '‚öñÔ∏è', color: 'bg-orange-700' },
          { type: 'digitalocean_domain', name: 'Domain', icon: 'üîó', color: 'bg-orange-800' },
          { type: 'digitalocean_record', name: 'DNS Record', icon: 'üìù', color: 'bg-orange-900' }
        ],
        'Project & Other': [
          { type: 'digitalocean_project', name: 'Project', icon: 'üìÅ', color: 'bg-pink-500' },
          { type: 'digitalocean_ssh_key', name: 'SSH Key', icon: 'üîë', color: 'bg-pink-600' },
          { type: 'digitalocean_floating_ip', name: 'Floating IP', icon: 'üéØ', color: 'bg-red-500' },
          { type: 'digitalocean_certificate', name: 'Certificate', icon: 'üîê', color: 'bg-red-600' }
        ]
      },
      kubernetes: {
        Workloads: [
          { type: 'kubernetes_deployment', name: 'Deployment', icon: 'üì¶', color: 'bg-blue-500' },
          { type: 'kubernetes_stateful_set', name: 'StatefulSet', icon: 'üíæ', color: 'bg-blue-600' },
          { type: 'kubernetes_daemon_set', name: 'DaemonSet', icon: 'üë•', color: 'bg-blue-700' },
          { type: 'kubernetes_job', name: 'Job', icon: '‚öôÔ∏è', color: 'bg-blue-800' },
          { type: 'kubernetes_cron_job', name: 'CronJob', icon: '‚è∞', color: 'bg-blue-900' }
        ],
        Network: [
          { type: 'kubernetes_service', name: 'Service', icon: 'üåê', color: 'bg-green-500' },
          { type: 'kubernetes_ingress', name: 'Ingress', icon: 'üö™', color: 'bg-green-600' },
          { type: 'kubernetes_ingress_v1', name: 'Ingress V1', icon: 'üö™', color: 'bg-green-600' },
          { type: 'kubernetes_ingress_class', name: 'IngressClass', icon: 'üè∑Ô∏è', color: 'bg-green-700' },
          { type: 'kubernetes_network_policy', name: 'NetworkPolicy', icon: 'üîí', color: 'bg-green-800' }
        ],
        'Config & Storage': [
          { type: 'kubernetes_config_map', name: 'ConfigMap', icon: '‚öôÔ∏è', color: 'bg-purple-500' },
          { type: 'kubernetes_secret', name: 'Secret', icon: 'üîê', color: 'bg-purple-600' },
          { type: 'kubernetes_persistent_volume', name: 'PersistentVolume', icon: 'üíø', color: 'bg-purple-700' },
          { type: 'kubernetes_persistent_volume_claim', name: 'PVC', icon: 'üìã', color: 'bg-purple-800' },
          { type: 'kubernetes_storage_class', name: 'StorageClass', icon: 'üóÑÔ∏è', color: 'bg-purple-900' }
        ],
        'Access Control': [
          { type: 'kubernetes_namespace', name: 'Namespace', icon: 'üìÅ', color: 'bg-orange-500' },
          { type: 'kubernetes_service_account', name: 'ServiceAccount', icon: 'üë§', color: 'bg-orange-600' },
          { type: 'kubernetes_role', name: 'Role', icon: 'üé≠', color: 'bg-orange-700' },
          { type: 'kubernetes_role_binding', name: 'RoleBinding', icon: 'üîó', color: 'bg-orange-800' },
          { type: 'kubernetes_cluster_role', name: 'ClusterRole', icon: 'üëë', color: 'bg-orange-900' }
        ]
      }
    };

    // Get current resource templates based on selected cloud provider
    function getResourceTemplates() {
      return cloudResourceTemplates[currentCloudProvider] || cloudResourceTemplates.aws;
    }

    // Initialize
    function init() {
      renderPalette();
      updateUI();
      setupEventListeners();
    }

    function renderPalette() {
      const palette = document.getElementById('resourcePalette');
      palette.innerHTML = '';

      const resourceTemplates = getResourceTemplates();

      for (const [category, items] of Object.entries(resourceTemplates)) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        categoryDiv.innerHTML = `<h3>${category}</h3>`;

        items.forEach(template => {
          const item = document.createElement('div');
          item.className = `resource-item ${template.color}`;
          item.innerHTML = `
            <div style="display: flex; align-items: center;">
              <span class="resource-icon">${template.icon}</span>
              <div>
                <div class="resource-name">${template.name}</div>
                <div class="resource-type">${template.type}</div>
              </div>
            </div>
          `;
          item.onmousedown = (e) => startDragFromPalette(e, template);
          categoryDiv.appendChild(item);
        });

        palette.appendChild(categoryDiv);
      }
    }

    // Switch cloud provider
    function switchCloudProvider() {
      const select = document.getElementById('cloudProviderSelect');
      currentCloudProvider = select.value;

      // Just re-render the palette with new provider resources
      // Keep existing resources on canvas (allows multi-cloud designs)
      renderPalette();
    }

    function setupEventListeners() {
      document.addEventListener('mousemove', handleGlobalMouseMove);
      document.addEventListener('mouseup', handleGlobalMouseUp);
    }

    function startDragFromPalette(e, template) {
      e.preventDefault();
      draggingFromPalette = template;
      updateGhostPreview(e.clientX, e.clientY, template);
    }

    function handleGlobalMouseMove(e) {
      if (draggingFromPalette) {
        updateGhostPreview(e.clientX, e.clientY, draggingFromPalette);
      } else if (draggingId) {
        const canvas = document.getElementById('canvas');
        const rect = canvas.getBoundingClientRect();
        const newX = (e.clientX - rect.left) / zoom - dragOffset.x;
        const newY = (e.clientY - rect.top) / zoom - dragOffset.y;
        
        // Ensure resource stays within canvas boundaries
        const RESOURCE_WIDTH = 200;
        const RESOURCE_HEIGHT = 120; // Approximate height
        const maxX = Math.max(0, rect.width / zoom - RESOURCE_WIDTH);
        const maxY = Math.max(0, rect.height / zoom - RESOURCE_HEIGHT);
        
        positions[draggingId] = { 
          x: Math.max(0, Math.min(maxX, newX)), 
          y: Math.max(0, Math.min(maxY, newY)) 
        };
        renderCanvas();
      }
    }

    function handleGlobalMouseUp(e) {
      if (draggingFromPalette) {
        const canvas = document.getElementById('canvas');
        const rect = canvas.getBoundingClientRect();
        if (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom) {
          const x = (e.clientX - rect.left) / zoom;
          const y = (e.clientY - rect.top) / zoom;
          addResource(draggingFromPalette, x, y);
        }
        draggingFromPalette = null;
        document.getElementById('ghostPreview').classList.remove('active');
      }
      draggingId = null;
    }

    function updateGhostPreview(x, y, template) {
      const ghost = document.getElementById('ghostPreview');
      ghost.style.left = x + 'px';
      ghost.style.top = y + 'px';
      ghost.style.transform = 'translate(-50%, -50%)';
      ghost.classList.add('active');
      ghost.innerHTML = `
        <div class="resource-item ${template.color}" style="box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
          <div style="display: flex; align-items: center;">
            <span class="resource-icon">${template.icon}</span>
            <div>
              <div class="resource-name">${template.name}</div>
              <div class="resource-type">${template.type}</div>
            </div>
          </div>
        </div>
      `;
    }

    function addResource(template, x, y) {
      const id = `resource-${nextId++}`;
      const resource = {
        id,
        type: template.type,
        name: `${template.name.toLowerCase().replace(/\s+/g, '_').replace(/:/g, '').replace(/data_/g, '')}_${nextId - 1}`,
        displayName: template.name,
        icon: template.icon,
        color: template.color,
        instanceType: template.defaultInstance,
        volumeSize: template.defaultSize || 0,
        ami: template.type === 'aws_instance' ? 'ami-04b3c39a8a1c62b76' : '',
        isData: template.isData || false,
        isModule: template.isModule || false,
        moduleSource: template.isModule ? 'terraform-aws-modules/vpc/aws' : '',
        moduleVersion: template.isModule ? '~> 5.0' : '',
        moduleVars: template.isModule ? {} : null,
        dataFilter: template.isData ? {} : null
      };
      resources.push(resource);
      
      // Ensure resource is placed within canvas boundaries
      const canvas = document.getElementById('canvas');
      const rect = canvas.getBoundingClientRect();
      const RESOURCE_WIDTH = 200;
      const RESOURCE_HEIGHT = 120; // Approximate height
      const maxX = Math.max(0, rect.width / zoom - RESOURCE_WIDTH);
      const maxY = Math.max(0, rect.height / zoom - RESOURCE_HEIGHT);
      
      positions[id] = { 
        x: Math.max(0, Math.min(maxX, x)), 
        y: Math.max(0, Math.min(maxY, y)) 
      };
      updateUI();
    }

    function renderCanvas() {
      const canvas = document.getElementById('canvas');
      const existingCards = canvas.querySelectorAll('.resource-card');
      existingCards.forEach(card => card.remove());

      resources.forEach(resource => {
        const pos = positions[resource.id];
        const card = document.createElement('div');
        card.className = 'resource-card';
        if (selectedResource === resource.id) card.classList.add('selected');
        if (connectionStart === resource.id) card.classList.add('connection-start');
        card.style.left = pos.x + 'px';
        card.style.top = pos.y + 'px';
        
        const cost = calculateCost(resource);
        card.innerHTML = `
          <div class="resource-card-header ${resource.color}">
            <div class="resource-card-title">
              <span style="font-size: 24px;">${resource.icon}</span>
              <span class="resource-card-name">${resource.name}</span>
            </div>
            <div class="resource-card-actions">
              <button class="icon-btn" onclick="openEditModal('${resource.id}')">‚úèÔ∏è</button>
              <button class="icon-btn" onclick="deleteResource('${resource.id}')">üóëÔ∏è</button>
            </div>
          </div>
          <div class="resource-card-body">
            <div class="resource-detail">${resource.type}${resource.isModule ? ' (Module)' : ''}${resource.isData ? ' (Data)' : ''}</div>
            ${resource.isModule ? `<div class="resource-detail">üì¶ ${resource.moduleSource || 'Not set'}</div>` : ''}
            ${resource.isModule && resource.moduleVersion ? `<div class="resource-detail">üè∑Ô∏è ${resource.moduleVersion}</div>` : ''}
            ${!resource.isModule && !resource.isData && resource.instanceType ? `<div class="resource-detail">üìä ${resource.instanceType.replace('_', '.')}</div>` : ''}
            ${!resource.isModule && !resource.isData && resource.ami ? `<div class="resource-detail" style="overflow: hidden; text-overflow: ellipsis;">üíø ${resource.ami}</div>` : ''}
            ${!resource.isModule && !resource.isData && resource.volumeSize > 0 ? `<div class="resource-detail">üíæ ${resource.volumeSize} GB</div>` : ''}
            ${!resource.isModule && cost > 0 ? `<div class="resource-cost">${cost.toFixed(2)}/mo</div>` : ''}
          </div>
        `;
        
        card.onmousedown = (e) => handleCardMouseDown(e, resource.id);
        canvas.appendChild(card);
      });

      renderConnections();
      updatePlaceholder();
    }

    function handleCardMouseDown(e, resourceId) {
      e.stopPropagation();
      
      // Check if click is on a button or in the actions area
      if (e.target.closest('.icon-btn') || e.target.closest('.resource-card-actions')) {
        return; // Don't start dragging if clicking on buttons
      }
      
      if (connectionMode) {
        if (!connectionStart) {
          connectionStart = resourceId;
          selectedResource = resourceId;
          document.getElementById('connectionMessage').textContent = 'üîó Now click the destination resource to complete the connection';
        } else if (connectionStart !== resourceId) {
          connections.push({ id: `conn-${Date.now()}`, from: connectionStart, to: resourceId });
          connectionStart = null;
          connectionMode = false;
          document.getElementById('connectBtn').classList.remove('btn-active');
          document.getElementById('connectBtn').classList.add('btn-secondary');
          document.getElementById('connectionBanner').classList.remove('active');
        }
        renderCanvas();
        updateUI();
        return;
      }

      draggingId = resourceId;
      selectedResource = resourceId;
      const pos = positions[resourceId];
      const canvas = document.getElementById('canvas');
      const rect = canvas.getBoundingClientRect();
      dragOffset = {
        x: (e.clientX - rect.left) / zoom - pos.x,
        y: (e.clientY - rect.top) / zoom - pos.y
      };
      renderCanvas();
    }

    function renderConnections() {
      const svg = document.getElementById('connectionsSvg');
      svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#8b5cf6" /></marker></defs>';

      connections.forEach(conn => {
        const fromPos = positions[conn.from];
        const toPos = positions[conn.to];
        if (!fromPos || !toPos) return;

        const fromCenter = { x: fromPos.x + 100, y: fromPos.y + 60 };
        const toCenter = { x: toPos.x + 100, y: toPos.y + 60 };

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', fromCenter.x);
        line.setAttribute('y1', fromCenter.y);
        line.setAttribute('x2', toCenter.x);
        line.setAttribute('y2', toCenter.y);
        line.setAttribute('stroke', '#8b5cf6');
        line.setAttribute('stroke-width', '3');
        line.setAttribute('marker-end', 'url(#arrowhead)');
        line.style.pointerEvents = 'auto';
        line.style.cursor = 'pointer';
        line.onclick = () => {
          if (confirm('Delete this connection?')) {
            connections = connections.filter(c => c.id !== conn.id);
            updateUI();
          }
        };
        g.appendChild(line);

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', (fromCenter.x + toCenter.x) / 2);
        circle.setAttribute('cy', (fromCenter.y + toCenter.y) / 2);
        circle.setAttribute('r', '8');
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#8b5cf6');
        circle.setAttribute('stroke-width', '2');
        circle.style.pointerEvents = 'auto';
        circle.style.cursor = 'pointer';
        circle.onclick = () => {
          if (confirm('Delete this connection?')) {
            connections = connections.filter(c => c.id !== conn.id);
            updateUI();
          }
        };
        g.appendChild(circle);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', (fromCenter.x + toCenter.x) / 2);
        text.setAttribute('y', (fromCenter.y + toCenter.y) / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('font-size', '10');
        text.setAttribute('fill', '#8b5cf6');
        text.textContent = '√ó';
        g.appendChild(text);

        const fromResource = resources.find(r => r.id === conn.from);
        const toResource = resources.find(r => r.id === conn.to);
        const label = getConnectionLabel(fromResource, toResource);
        
        const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        labelText.setAttribute('x', (fromCenter.x + toCenter.x) / 2);
        labelText.setAttribute('y', (fromCenter.y + toCenter.y) / 2 - 15);
        labelText.setAttribute('text-anchor', 'middle');
        labelText.setAttribute('font-size', '11');
        labelText.setAttribute('fill', '#6b21a8');
        labelText.setAttribute('font-weight', '600');
        labelText.textContent = label;
        g.appendChild(labelText);

        svg.appendChild(g);
      });
    }

    function getConnectionLabel(fromResource, toResource) {
      if (!fromResource || !toResource) return '';
      
      // Handle data source connections
      if (fromResource.isData) {
        if (fromResource.type === 'data.aws_vpc' && toResource.type === 'aws_subnet') return 'vpc_id (data)';
        if (fromResource.type === 'data.aws_subnet' && toResource.type === 'aws_instance') return 'subnet_id (data)';
        if (fromResource.type === 'data.aws_ami' && toResource.type === 'aws_instance') return 'ami (data)';
        return 'data reference';
      }
      
      // Handle module connections
      if (fromResource.isModule) {
        return 'module output';
      }
      if (toResource.isModule) {
        return 'module input';
      }
      
      // Regular resource connections
      if (fromResource.type === 'aws_vpc' && toResource.type === 'aws_subnet') return 'vpc_id';
      if (fromResource.type === 'aws_subnet' && toResource.type === 'aws_instance') return 'subnet_id';
      if (fromResource.type === 'aws_subnet' && toResource.type === 'aws_rds_instance') return 'subnet_id';
      if (fromResource.type === 'aws_subnet' && toResource.type === 'aws_lb') return 'subnets';
      if (fromResource.type === 'aws_security_group' && toResource.type === 'aws_instance') return 'security_groups';
      if (fromResource.type === 'aws_vpc' && toResource.type === 'aws_security_group') return 'vpc_id';
      
      return 'connection';
    }

    function updatePlaceholder() {
      document.getElementById('placeholder').style.display = resources.length > 0 ? 'none' : 'block';
    }

    function calculateCost(resource) {
      // AWS pricing
      if (resource.type === 'aws_instance' && resource.instanceType) {
        return pricing.aws_instance[resource.instanceType] || 8.47;
      } else if (resource.type === 'aws_rds_instance' && resource.instanceType) {
        return pricing.aws_rds_instance[resource.instanceType] || 14.02;
      } else if (resource.type === 'aws_ebs_volume' && resource.volumeSize) {
        return pricing.aws_ebs_volume * resource.volumeSize;
      }
      // GCP pricing
      else if (resource.type === 'google_compute_instance' && resource.instanceType) {
        return pricing.google_compute_instance[resource.instanceType] || 24.46;
      } else if (resource.type === 'google_sql_database_instance' && resource.instanceType) {
        return pricing.google_sql_database_instance[resource.instanceType] || 25.00;
      } else if (resource.type === 'google_compute_disk' && resource.volumeSize) {
        return pricing.google_compute_disk * resource.volumeSize;
      }
      // Azure pricing
      else if (resource.type === 'azurerm_virtual_machine' && resource.instanceType) {
        return pricing.azurerm_virtual_machine[resource.instanceType] || 30.37;
      } else if (resource.type === 'azurerm_mssql_database' && resource.instanceType) {
        return pricing.azurerm_mssql_database[resource.instanceType] || 15.00;
      } else if (resource.type === 'azurerm_managed_disk' && resource.volumeSize) {
        return pricing.azurerm_managed_disk * resource.volumeSize;
      }
      // DigitalOcean pricing
      else if (resource.type === 'digitalocean_droplet' && resource.instanceType) {
        return pricing.digitalocean_droplet[resource.instanceType] || 24;
      } else if (resource.type === 'digitalocean_database_cluster' && resource.instanceType) {
        return pricing.digitalocean_database_cluster[resource.instanceType] || 60;
      } else if (resource.type === 'digitalocean_volume' && resource.volumeSize) {
        return pricing.digitalocean_volume * resource.volumeSize;
      }
      // Default pricing for other resources
      else if (typeof pricing[resource.type] === 'number') {
        return pricing[resource.type];
      }
      return 0;
    }

    function calculateTotalCost() {
      return resources.reduce((sum, r) => sum + calculateCost(r), 0);
    }

    function updateUI() {
      ensureCanvasSize();
      renderCanvas();
      updateTotalCost();
      updateResourceCount();
      generateCode();
      updateButtons();
    }

    function ensureCanvasSize() {
      if (resources.length === 0) return;

      // Find the maximum Y position to determine required height
      let maxY = 0;
      resources.forEach(resource => {
        const pos = positions[resource.id];
        if (pos && pos.y > maxY) {
          maxY = pos.y;
        }
      });

      // Add padding for the resource card height (~150px) and bottom margin
      const requiredHeight = maxY + 350;
      const canvas = document.getElementById('canvas');
      const svg = document.getElementById('connectionsSvg');
      const currentHeight = parseInt(canvas.style.height) || 1200;

      // Expand height if needed (width stays fixed, users scroll horizontally)
      if (requiredHeight > currentHeight) {
        canvas.style.height = requiredHeight + 'px';
        if (svg) {
          svg.style.height = requiredHeight + 'px';
        }
        console.log(`Canvas height expanded to ${requiredHeight}px (width stays fixed for scrolling)`);
      } else if (requiredHeight < 1200 && currentHeight > 1200) {
        // Reset to default if resources fit in smaller space
        canvas.style.height = '1200px';
        if (svg) {
          svg.style.height = '1200px';
        }
      }
    }

    function updateTotalCost() {
      const total = resources.reduce((sum, r) => sum + calculateCost(r), 0);
      document.getElementById('totalCost').textContent = `$${total.toFixed(2)}/mo`;
    }

    function updateResourceCount() {
      document.getElementById('resourceCount').textContent = `(${resources.length} resources)`;
    }

    function updateButtons() {
      document.getElementById('clearBtn').style.display = resources.length > 0 ? 'flex' : 'none';
      document.getElementById('exportBtn').style.display = resources.length > 0 ? 'flex' : 'none';
    }

    function generateCode() {
      let code = '';
      
      resources.forEach(resource => {
        // Handle Data Sources
        if (resource.isData) {
          const dataType = resource.type.replace('data.', '');
          code += `data "${dataType}" "${resource.name}" {\n`;
          
          if (dataType === 'aws_ami') {
            code += `  most_recent = true\n`;
            code += `  owners      = ["amazon"]\n\n`;
            code += `  filter {\n`;
            code += `    name   = "name"\n`;
            code += `    values = ["amzn2-ami-hvm-*-x86_64-gp2"]\n`;
            code += `  }\n`;
          } else if (dataType === 'aws_vpc') {
            code += `  default = true\n`;
          } else if (dataType === 'aws_availability_zones') {
            code += `  state = "available"\n`;
          }
          
          code += `}\n\n`;
          return;
        }
        
        // Handle Modules
        if (resource.isModule) {
          const moduleName = resource.type.replace('module.', '');
          code += `module "${resource.name}" {\n`;
          code += `  source  = "${resource.moduleSource || 'terraform-aws-modules/vpc/aws'}"\n`;
          code += `  version = "${resource.moduleVersion || '~> 5.0'}"\n\n`;
          
          // Add example variables based on module type
          if (moduleName === 'vpc' || resource.type === 'module.vpc') {
            code += `  name = "${resource.displayName}"\n`;
            code += `  cidr = "10.0.0.0/16"\n\n`;
            code += `  azs             = ["us-east-1a", "us-east-1b"]\n`;
            code += `  private_subnets = ["10.0.1.0/24", "10.0.2.0/24"]\n`;
            code += `  public_subnets  = ["10.0.101.0/24", "10.0.102.0/24"]\n\n`;
            code += `  enable_nat_gateway = true\n`;
            code += `  enable_vpn_gateway = false\n`;
          } else if (moduleName === 'eks' || resource.type === 'module.eks') {
            code += `  cluster_name    = "${resource.name}"\n`;
            code += `  cluster_version = "1.28"\n\n`;
            code += `  vpc_id          = module.vpc.vpc_id\n`;
            code += `  subnet_ids      = module.vpc.private_subnets\n`;
          } else if (moduleName === 'rds' || resource.type === 'module.rds') {
            code += `  identifier = "${resource.name}"\n\n`;
            code += `  engine            = "postgres"\n`;
            code += `  engine_version    = "14.7"\n`;
            code += `  instance_class    = "db.t3.medium"\n`;
            code += `  allocated_storage = 20\n`;
          } else {
            code += `  # Add your module variables here\n`;
          }
          
          code += `}\n\n`;
          return;
        }
        
        // Handle regular resources
        code += `resource "${resource.type}" "${resource.name}" {\n`;
        
        if (resource.type === 'aws_instance') {
          code += `  ami           = "${resource.ami || 'ami-04b3c39a8a1c62b76'}"\n`;
          code += `  instance_type = "${(resource.instanceType || 't3_medium').replace('_', '.')}"\n`;
          
          const incomingConns = connections.filter(c => c.to === resource.id);
          incomingConns.forEach(conn => {
            const sourceResource = resources.find(r => r.id === conn.from);
            if (sourceResource) {
              if (sourceResource.type === 'aws_subnet') {
                code += `  subnet_id     = aws_subnet.${sourceResource.name}.id\n`;
              } else if (sourceResource.type === 'aws_vpc') {
                code += `  vpc_id        = aws_vpc.${sourceResource.name}.id\n`;
              } else if (sourceResource.type === 'aws_security_group') {
                code += `  vpc_security_group_ids = [aws_security_group.${sourceResource.name}.id]\n`;
              } else if (sourceResource.isData && sourceResource.type === 'data.aws_subnet') {
                code += `  subnet_id     = data.aws_subnet.${sourceResource.name}.id\n`;
              } else if (sourceResource.isData && sourceResource.type === 'data.aws_ami') {
                code += `  # ami can reference: data.aws_ami.${sourceResource.name}.id\n`;
              }
            }
          });
          
          code += `\n  tags = {\n    Name = "${resource.displayName}"\n  }\n`;
        } else if (resource.type === 'aws_rds_instance') {
          code += `  allocated_storage = 20\n`;
          code += `  engine           = "postgres"\n`;
          code += `  instance_class   = "${(resource.instanceType || 'db_t3_small').replace('_', '.')}"\n`;
          code += `  db_name          = "${resource.name}"\n`;
          
          const incomingConns = connections.filter(c => c.to === resource.id);
          incomingConns.forEach(conn => {
            const sourceResource = resources.find(r => r.id === conn.from);
            if (sourceResource && sourceResource.type === 'aws_security_group') {
              code += `  vpc_security_group_ids = [aws_security_group.${sourceResource.name}.id]\n`;
            }
          });
        } else if (resource.type === 'aws_subnet') {
          code += `  cidr_block = "${resource.cidrBlock || '10.0.1.0/24'}"\n`;

          // Check if vpc_id is manually set
          if (resource.vpcId) {
            code += `  vpc_id     = "${resource.vpcId}"\n`;
          } else {
            // Otherwise check connections
            const incomingConns = connections.filter(c => c.to === resource.id);
            incomingConns.forEach(conn => {
              const sourceResource = resources.find(r => r.id === conn.from);
              if (sourceResource && sourceResource.type === 'aws_vpc') {
                code += `  vpc_id     = aws_vpc.${sourceResource.name}.id\n`;
              } else if (sourceResource && sourceResource.isData && sourceResource.type === 'data.aws_vpc') {
                code += `  vpc_id     = data.aws_vpc.${sourceResource.name}.id\n`;
              }
            });
          }

          if (resource.availabilityZone) {
            code += `  availability_zone = "${resource.availabilityZone}"\n`;
          }
        } else if (resource.type === 'aws_vpc') {
          code += `  cidr_block = "10.0.0.0/16"\n\n`;
          code += `  tags = {\n    Name = "${resource.displayName}"\n  }\n`;
        } else if (resource.type === 'aws_security_group') {
          code += `  name        = "${resource.name}"\n`;
          code += `  description = "Security group for ${resource.displayName}"\n`;
          
          const incomingConns = connections.filter(c => c.to === resource.id);
          incomingConns.forEach(conn => {
            const sourceResource = resources.find(r => r.id === conn.from);
            if (sourceResource && sourceResource.type === 'aws_vpc') {
              code += `  vpc_id     = aws_vpc.${sourceResource.name}.id\n`;
            }
          });
        } else if (resource.type === 'aws_s3_bucket') {
          code += `  bucket = "${resource.name}"\n`;
        } else if (resource.type === 'aws_ebs_volume') {
          code += `  availability_zone = "us-east-1a"\n`;
          code += `  size             = ${resource.volumeSize || 100}\n`;
        } else if (resource.type === 'aws_lb') {
          code += `  name               = "${resource.name}"\n`;
          code += `  internal           = false\n`;
          code += `  load_balancer_type = "application"\n`;

          const incomingConns = connections.filter(c => c.to === resource.id);
          const subnetConns = incomingConns.filter(conn => {
            const sourceResource = resources.find(r => r.id === conn.from);
            return sourceResource && sourceResource.type === 'aws_subnet';
          });

          if (subnetConns.length > 0) {
            code += `  subnets            = [\n`;
            subnetConns.forEach((conn, idx) => {
              const sourceResource = resources.find(r => r.id === conn.from);
              code += `    aws_subnet.${sourceResource.name}.id${idx < subnetConns.length - 1 ? ',' : ''}\n`;
            });
            code += `  ]\n`;
          }
        }
        // Google Cloud Platform Resources
        else if (resource.type === 'google_compute_instance') {
          code += `  name         = "${resource.name}"\n`;
          code += `  machine_type = "${(resource.instanceType || 'e2_medium').replace('_', '-')}"\n`;
          code += `  zone         = "us-central1-a"\n\n`;
          code += `  boot_disk {\n`;
          code += `    initialize_params {\n`;
          code += `      image = "debian-cloud/debian-11"\n`;
          code += `    }\n`;
          code += `  }\n\n`;
          code += `  network_interface {\n`;
          code += `    network = "default"\n`;
          code += `  }\n`;
        } else if (resource.type === 'google_cloudfunctions_function') {
          code += `  name        = "${resource.name}"\n`;
          code += `  runtime     = "python39"\n`;
          code += `  entry_point = "main"\n`;
          code += `  region      = "us-central1"\n\n`;
          code += `  source_archive_bucket = google_storage_bucket.function_bucket.name\n`;
          code += `  source_archive_object = google_storage_bucket_object.function_zip.name\n`;
        } else if (resource.type === 'google_cloud_run_service') {
          code += `  name     = "${resource.name}"\n`;
          code += `  location = "us-central1"\n\n`;
          code += `  template {\n`;
          code += `    spec {\n`;
          code += `      containers {\n`;
          code += `        image = "gcr.io/cloudrun/hello"\n`;
          code += `      }\n`;
          code += `    }\n`;
          code += `  }\n`;
        } else if (resource.type === 'google_sql_database_instance') {
          code += `  name             = "${resource.name}"\n`;
          code += `  database_version = "POSTGRES_14"\n`;
          code += `  region           = "us-central1"\n\n`;
          code += `  settings {\n`;
          code += `    tier = "${(resource.instanceType || 'db_g1_small').replace('_', '-')}"\n`;
          code += `  }\n`;
        } else if (resource.type === 'google_bigtable_instance') {
          code += `  name         = "${resource.name}"\n`;
          code += `  cluster {\n`;
          code += `    cluster_id   = "${resource.name}-cluster"\n`;
          code += `    num_nodes    = 3\n`;
          code += `    storage_type = "SSD"\n`;
          code += `  }\n`;
        } else if (resource.type === 'google_redis_instance') {
          code += `  name           = "${resource.name}"\n`;
          code += `  tier           = "BASIC"\n`;
          code += `  memory_size_gb = 1\n`;
          code += `  region         = "us-central1"\n`;
        } else if (resource.type === 'google_storage_bucket') {
          code += `  name     = "${resource.name}"\n`;
          code += `  location = "US"\n`;
        } else if (resource.type === 'google_compute_disk') {
          code += `  name = "${resource.name}"\n`;
          code += `  type = "pd-standard"\n`;
          code += `  zone = "us-central1-a"\n`;
          code += `  size = ${resource.volumeSize || 100}\n`;
        }
        // Azure Resources
        else if (resource.type === 'azurerm_virtual_machine') {
          code += `  name                  = "${resource.name}"\n`;
          code += `  location              = "eastus"\n`;
          code += `  resource_group_name   = azurerm_resource_group.main.name\n`;
          code += `  vm_size               = "${(resource.instanceType || 'Standard_B2s')}"\n\n`;
          code += `  storage_os_disk {\n`;
          code += `    name              = "${resource.name}-osdisk"\n`;
          code += `    caching           = "ReadWrite"\n`;
          code += `    create_option     = "FromImage"\n`;
          code += `    managed_disk_type = "Standard_LRS"\n`;
          code += `  }\n\n`;
          code += `  storage_image_reference {\n`;
          code += `    publisher = "Canonical"\n`;
          code += `    offer     = "UbuntuServer"\n`;
          code += `    sku       = "18.04-LTS"\n`;
          code += `    version   = "latest"\n`;
          code += `  }\n`;
        } else if (resource.type === 'azurerm_function_app') {
          code += `  name                       = "${resource.name}"\n`;
          code += `  location                   = "eastus"\n`;
          code += `  resource_group_name        = azurerm_resource_group.main.name\n`;
          code += `  app_service_plan_id        = azurerm_app_service_plan.main.id\n`;
          code += `  storage_account_name       = azurerm_storage_account.main.name\n`;
          code += `  storage_account_access_key = azurerm_storage_account.main.primary_access_key\n`;
        } else if (resource.type === 'azurerm_mssql_database') {
          code += `  name         = "${resource.name}"\n`;
          code += `  server_id    = azurerm_mssql_server.main.id\n`;
          code += `  collation    = "SQL_Latin1_General_CP1_CI_AS"\n`;
          code += `  sku_name     = "${resource.instanceType || 'S0'}"\n`;
        } else if (resource.type === 'azurerm_cosmosdb_account') {
          code += `  name                = "${resource.name}"\n`;
          code += `  location            = "eastus"\n`;
          code += `  resource_group_name = azurerm_resource_group.main.name\n`;
          code += `  offer_type          = "Standard"\n`;
          code += `  kind                = "GlobalDocumentDB"\n\n`;
          code += `  consistency_policy {\n`;
          code += `    consistency_level = "Session"\n`;
          code += `  }\n\n`;
          code += `  geo_location {\n`;
          code += `    location          = "eastus"\n`;
          code += `    failover_priority = 0\n`;
          code += `  }\n`;
        } else if (resource.type === 'azurerm_redis_cache') {
          code += `  name                = "${resource.name}"\n`;
          code += `  location            = "eastus"\n`;
          code += `  resource_group_name = azurerm_resource_group.main.name\n`;
          code += `  capacity            = 0\n`;
          code += `  family              = "C"\n`;
          code += `  sku_name            = "Basic"\n`;
        } else if (resource.type === 'azurerm_storage_account') {
          code += `  name                     = "${resource.name.replace(/-/g, '')}"\n`;
          code += `  resource_group_name      = azurerm_resource_group.main.name\n`;
          code += `  location                 = "eastus"\n`;
          code += `  account_tier             = "Standard"\n`;
          code += `  account_replication_type = "LRS"\n`;
        } else if (resource.type === 'azurerm_managed_disk') {
          code += `  name                 = "${resource.name}"\n`;
          code += `  location             = "eastus"\n`;
          code += `  resource_group_name  = azurerm_resource_group.main.name\n`;
          code += `  storage_account_type = "Standard_LRS"\n`;
          code += `  create_option        = "Empty"\n`;
          code += `  disk_size_gb         = ${resource.volumeSize || 100}\n`;
        }
        // DigitalOcean Resources
        else if (resource.type === 'digitalocean_droplet') {
          code += `  image  = "${resource.image || 'ubuntu-22-04-x64'}"\n`;
          code += `  name   = "${resource.name}"\n`;
          code += `  region = "${resource.region || 'nyc3'}"\n`;
          code += `  size   = "${resource.instanceType || 's-2vcpu-4gb'}"\n`;
        } else if (resource.type === 'digitalocean_kubernetes_cluster') {
          code += `  name    = "${resource.name}"\n`;
          code += `  region  = "${resource.region || 'nyc3'}"\n`;
          code += `  version = "1.28.2-do.0"\n\n`;
          code += `  node_pool {\n`;
          code += `    name       = "${resource.name}-pool"\n`;
          code += `    size       = "s-2vcpu-4gb"\n`;
          code += `    node_count = 3\n`;
          code += `  }\n`;
        } else if (resource.type === 'digitalocean_app') {
          code += `  spec {\n`;
          code += `    name   = "${resource.name}"\n`;
          code += `    region = "nyc"\n\n`;
          code += `    service {\n`;
          code += `      name               = "web"\n`;
          code += `      instance_count     = 1\n`;
          code += `      instance_size_slug = "basic-xxs"\n`;
          code += `    }\n`;
          code += `  }\n`;
        } else if (resource.type === 'digitalocean_database_cluster') {
          code += `  name       = "${resource.name}"\n`;
          code += `  engine     = "${resource.engine || 'pg'}"\n`;
          code += `  version    = "15"\n`;
          code += `  size       = "${resource.instanceType || 'db-s-2vcpu-4gb'}"\n`;
          code += `  region     = "nyc3"\n`;
          code += `  node_count = 1\n`;
        } else if (resource.type === 'digitalocean_database_db') {
          code += `  cluster_id = digitalocean_database_cluster.main.id\n`;
          code += `  name       = "${resource.name}"\n`;
        } else if (resource.type === 'digitalocean_database_user') {
          code += `  cluster_id = digitalocean_database_cluster.main.id\n`;
          code += `  name       = "${resource.name}"\n`;
        } else if (resource.type === 'digitalocean_spaces_bucket') {
          code += `  name   = "${resource.bucketName || resource.name}"\n`;
          code += `  region = "nyc3"\n`;
          code += `  acl    = "${resource.acl || 'private'}"\n`;
        } else if (resource.type === 'digitalocean_volume') {
          code += `  region                  = "nyc3"\n`;
          code += `  name                    = "${resource.name}"\n`;
          code += `  size                    = ${resource.volumeSize || 100}\n`;
          code += `  initial_filesystem_type = "ext4"\n`;
        } else if (resource.type === 'digitalocean_cdn') {
          code += `  origin = digitalocean_spaces_bucket.main.bucket_domain_name\n`;
        } else if (resource.type === 'digitalocean_vpc') {
          code += `  name     = "${resource.name}"\n`;
          code += `  region   = "nyc3"\n`;
          code += `  ip_range = "${resource.ipRange || '10.10.10.0/24'}"\n`;
        } else if (resource.type === 'digitalocean_firewall') {
          code += `  name = "${resource.name}"\n\n`;
          code += `  droplet_ids = []\n\n`;
          code += `  inbound_rule {\n`;
          code += `    protocol         = "tcp"\n`;
          code += `    port_range       = "22"\n`;
          code += `    source_addresses = ["0.0.0.0/0", "::/0"]\n`;
          code += `  }\n\n`;
          code += `  inbound_rule {\n`;
          code += `    protocol         = "tcp"\n`;
          code += `    port_range       = "80"\n`;
          code += `    source_addresses = ["0.0.0.0/0", "::/0"]\n`;
          code += `  }\n\n`;
          code += `  inbound_rule {\n`;
          code += `    protocol         = "tcp"\n`;
          code += `    port_range       = "443"\n`;
          code += `    source_addresses = ["0.0.0.0/0", "::/0"]\n`;
          code += `  }\n\n`;
          code += `  outbound_rule {\n`;
          code += `    protocol              = "tcp"\n`;
          code += `    port_range            = "1-65535"\n`;
          code += `    destination_addresses = ["0.0.0.0/0", "::/0"]\n`;
          code += `  }\n`;
        } else if (resource.type === 'digitalocean_loadbalancer') {
          code += `  name   = "${resource.name}"\n`;
          code += `  region = "nyc3"\n\n`;
          code += `  forwarding_rule {\n`;
          code += `    entry_port     = 80\n`;
          code += `    entry_protocol = "http"\n\n`;
          code += `    target_port     = 80\n`;
          code += `    target_protocol = "http"\n`;
          code += `  }\n\n`;
          code += `  healthcheck {\n`;
          code += `    port     = 80\n`;
          code += `    protocol = "http"\n`;
          code += `    path     = "/"\n`;
          code += `  }\n`;
        } else if (resource.type === 'digitalocean_domain') {
          code += `  name = "${resource.domain || resource.name}"\n`;
        } else if (resource.type === 'digitalocean_record') {
          code += `  domain = digitalocean_domain.main.name\n`;
          code += `  type   = "${resource.recordType || 'A'}"\n`;
          code += `  name   = "${resource.recordName || resource.name}"\n`;
          code += `  value  = "${resource.recordValue || '192.0.2.1'}"\n`;
        } else if (resource.type === 'digitalocean_project') {
          code += `  name        = "${resource.name}"\n`;
          code += `  description = "${resource.description || 'A project for ' + resource.displayName}"\n`;
          code += `  purpose     = "${resource.purpose || 'Web Application'}"\n`;
          code += `  environment = "${resource.environment || 'Production'}"\n`;
        } else if (resource.type === 'digitalocean_ssh_key') {
          code += `  name       = "${resource.name}"\n`;
          code += `  public_key = file("~/.ssh/id_rsa.pub")\n`;
        } else if (resource.type === 'digitalocean_floating_ip') {
          code += `  region = "nyc3"\n`;
        } else if (resource.type === 'digitalocean_certificate') {
          code += `  name             = "${resource.name}"\n`;
          code += `  type             = "lets_encrypt"\n`;
          code += `  domains          = ["example.com"]\n`;
        }
        // Kubernetes Resources
        else if (resource.type === 'kubernetes_deployment') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `    labels = {\n`;
          code += `      app = "${resource.name}"\n`;
          code += `    }\n`;
          code += `  }\n\n`;
          code += `  spec {\n`;
          code += `    replicas = ${resource.replicas || 3}\n\n`;
          code += `    selector {\n`;
          code += `      match_labels = {\n`;
          code += `        app = "${resource.name}"\n`;
          code += `      }\n`;
          code += `    }\n\n`;
          code += `    template {\n`;
          code += `      metadata {\n`;
          code += `        labels = {\n`;
          code += `          app = "${resource.name}"\n`;
          code += `        }\n`;
          code += `      }\n\n`;
          code += `      spec {\n`;
          code += `        container {\n`;
          code += `          name  = "${resource.name}"\n`;
          code += `          image = "${resource.image || 'nginx:latest'}"\n\n`;
          code += `          port {\n`;
          code += `            container_port = ${resource.containerPort || 80}\n`;
          code += `          }\n`;
          code += `        }\n`;
          code += `      }\n`;
          code += `    }\n`;
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_service') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `  }\n\n`;
          code += `  spec {\n`;
          code += `    selector = {\n`;
          code += `      app = "${resource.app || resource.name}"\n`;
          code += `    }\n\n`;
          code += `    type = "${resource.serviceType || 'ClusterIP'}"\n\n`;
          code += `    port {\n`;
          code += `      port        = ${resource.port || 80}\n`;
          code += `      target_port = ${resource.targetPort || 80}\n`;
          code += `    }\n`;
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_ingress') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `    annotations = {\n`;
          code += `      "kubernetes.io/ingress.class" = "${resource.ingressClass || 'nginx'}"\n`;
          code += `    }\n`;
          code += `  }\n\n`;
          code += `  spec {\n`;

          // Always generate rule block with defaults
          code += `    rule {\n`;
          code += `      host = "${resource.host || 'example.com'}"\n\n`;
          code += `      http {\n`;
          code += `        path {\n`;
          code += `          path = "${resource.path || '/'}"\n\n`;
          code += `          backend {\n`;
          code += `            service_name = "${resource.serviceName || 'example-service'}"\n`;
          code += `            service_port = ${resource.servicePort || 80}\n`;
          code += `          }\n`;
          code += `        }\n`;
          code += `      }\n`;
          code += `    }\n`;

          // Generate TLS block if enabled
          if (resource.tlsEnabled) {
            code += `\n    tls {\n`;
            code += `      hosts       = ["${resource.host || 'example.com'}"]\n`;
            code += `      secret_name = "${resource.tlsSecret || 'tls-secret'}"\n`;
            code += `    }\n`;
          }
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_ingress_v1') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `  }\n\n`;
          code += `  spec {\n`;

          // Always generate ingress_class_name if present
          if (resource.ingressClass) {
            code += `    ingress_class_name = "${resource.ingressClass}"\n\n`;
          }

          // Always generate rule block with defaults
          code += `    rule {\n`;
          code += `      host = "${resource.host || 'example.com'}"\n\n`;
          code += `      http {\n`;
          code += `        path {\n`;
          code += `          path = "${resource.path || '/'}"\n`;
          code += `          path_type = "${resource.pathType || 'Prefix'}"\n\n`;
          code += `          backend {\n`;
          code += `            service {\n`;
          code += `              name = "${resource.serviceName || 'example-service'}"\n`;
          code += `              port {\n`;
          code += `                number = ${resource.servicePort || 80}\n`;
          code += `              }\n`;
          code += `            }\n`;
          code += `          }\n`;
          code += `        }\n`;
          code += `      }\n`;
          code += `    }\n`;

          // Generate TLS block if enabled
          if (resource.tlsEnabled) {
            code += `\n    tls {\n`;
            code += `      hosts       = ["${resource.host || 'example.com'}"]\n`;
            code += `      secret_name = "${resource.tlsSecret || 'tls-secret'}"\n`;
            code += `    }\n`;
          }
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_config_map') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `  }\n\n`;
          code += `  data = {\n`;
          code += `    "config.yaml" = "# Add your configuration here"\n`;
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_secret') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `  }\n\n`;
          code += `  type = "Opaque"\n\n`;
          code += `  data = {\n`;
          code += `    username = base64encode("admin")\n`;
          code += `    password = base64encode("changeme")\n`;
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_namespace') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `  }\n`;
        } else if (resource.type === 'kubernetes_persistent_volume_claim') {
          code += `  metadata {\n`;
          code += `    name = "${resource.name}"\n`;
          code += `  }\n\n`;
          code += `  spec {\n`;
          code += `    access_modes = ["ReadWriteOnce"]\n\n`;
          code += `    resources {\n`;
          code += `      requests = {\n`;
          code += `        storage = "${resource.storage || '10Gi'}"\n`;
          code += `      }\n`;
          code += `    }\n`;
          code += `  }\n`;
        }

        code += `}\n\n`;
      });
      
      const output = document.getElementById('codeOutput');
      output.innerHTML = resources.length === 0 
        ? '<div style="color: #6b7280; text-align: center; margin-top: 32px;">Generated Terraform code will appear here</div>'
        : `<pre>${code}</pre>`;
    }

    function deleteResource(id) {
      resources = resources.filter(r => r.id !== id);
      delete positions[id];
      connections = connections.filter(c => c.from !== id && c.to !== id);
      if (selectedResource === id) selectedResource = null;
      updateUI();
    }

    function clearAll() {
      if (confirm('Clear all resources?')) {
        resources = [];
        connections = [];
        positions = {};
        selectedResource = null;
        connectionMode = false;
        connectionStart = null;
        document.getElementById('connectBtn').classList.remove('btn-active');
        document.getElementById('connectBtn').classList.add('btn-secondary');
        document.getElementById('connectionBanner').classList.remove('active');
        updateUI();
      }
    }

    function toggleConnectionMode() {
      connectionMode = !connectionMode;
      connectionStart = null;
      const btn = document.getElementById('connectBtn');
      const banner = document.getElementById('connectionBanner');
      const canvas = document.getElementById('canvas');
      
      if (connectionMode) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-active');
        btn.textContent = 'üîó Connecting...';
        banner.classList.add('active');
        canvas.classList.add('connection-mode');
        document.getElementById('connectionMessage').textContent = 'üîó Connection Mode Active: Click a resource to start';
      } else {
        btn.classList.remove('btn-active');
        btn.classList.add('btn-secondary');
        btn.textContent = 'üîó Connect';
        banner.classList.remove('active');
        canvas.classList.remove('connection-mode');
      }
      
      renderCanvas();
    }

    function cancelConnection() {
      connectionMode = false;
      connectionStart = null;
      document.getElementById('connectBtn').classList.remove('btn-active');
      document.getElementById('connectBtn').classList.add('btn-secondary');
      document.getElementById('connectBtn').textContent = 'üîó Connect';
      document.getElementById('connectionBanner').classList.remove('active');
      document.getElementById('canvas').classList.remove('connection-mode');
      renderCanvas();
    }

    function openEditModal(id) {
      // Convert string ID to number if needed
      const numId = typeof id === 'string' ? parseInt(id) : id;
      console.log('Opening edit modal for resource ID:', numId, '(original:', id, ')');
      console.log('Current resources:', resources);

      const resource = resources.find(r => r.id === numId);
      console.log('Found resource:', resource);

      if (!resource) {
        console.error('Resource not found for ID:', numId);
        console.error('Available resource IDs:', resources.map(r => r.id));
        return;
      }

      const modal = document.getElementById('editModal');
      const form = document.getElementById('editForm');
      
      let formHTML = `
        <div class="form-group">
          <label class="form-label">Resource Type</label>
          <input type="text" class="form-input" value="${resource.type || ''}" disabled>
        </div>
      `;

      // Module-specific fields
      if (resource.isModule) {
        formHTML += `
          <div class="form-group">
            <label class="form-label">Module Name</label>
            <input type="text" class="form-input" id="editName" value="${resource.name || ''}" placeholder="e.g., my_vpc_module">
          </div>
          <div class="form-group">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-input" id="editDisplayName" value="${resource.displayName || ''}" placeholder="e.g., My VPC Module">
          </div>
          <div class="form-group">
            <label class="form-label">Module Source</label>
            <input type="text" class="form-input" id="editModuleSource" value="${resource.moduleSource || ''}" placeholder="e.g., terraform-aws-modules/vpc/aws">
            <div class="form-hint">Registry path or Git URL</div>
          </div>
          <div class="form-group">
            <label class="form-label">Module Version</label>
            <input type="text" class="form-input" id="editModuleVersion" value="${resource.moduleVersion || ''}" placeholder="e.g., ~> 5.0">
            <div class="form-hint">Version constraint</div>
          </div>
        `;
      }
      // Data source-specific fields
      else if (resource.isData) {
        formHTML += `
          <div class="form-group">
            <label class="form-label">Data Source Name</label>
            <input type="text" class="form-input" id="editName" value="${resource.name || ''}" placeholder="e.g., latest_ami">
          </div>
          <div class="form-group">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-input" id="editDisplayName" value="${resource.displayName || ''}" placeholder="e.g., Latest AMI">
          </div>
          <div class="form-group">
            <label class="form-label">Filter/Query</label>
            <textarea class="form-input" id="editDataFilter" rows="3" placeholder="Add filter attributes here">${JSON.stringify(resource.dataFilter || {}, null, 2)}</textarea>
            <div class="form-hint">Data source filters (JSON format)</div>
          </div>
        `;
      }
      // Regular resource fields
      else {
        formHTML += `
          <div class="form-group">
            <label class="form-label">Resource Name (Terraform ID)</label>
            <input type="text" class="form-input" id="editName" value="${resource.name || ''}" placeholder="e.g., my_ec2_instance">
          </div>
          <div class="form-group">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-input" id="editDisplayName" value="${resource.displayName || ''}" placeholder="e.g., My EC2 Instance">
          </div>
        `;

        if (resource.type === 'aws_instance') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">AMI ID</label>
              <input type="text" class="form-input" id="editAmi" value="${resource.ami || 'ami-04b3c39a8a1c62b76'}" placeholder="e.g., ami-04b3c39a8a1c62b76">
              <div class="form-hint">Amazon Machine Image ID for the EC2 instance</div>
            </div>
            <div class="form-group">
              <label class="form-label">Instance Type</label>
              <select class="form-select" id="editInstanceType">
                <option value="t2_micro" ${resource.instanceType === 't2_micro' ? 'selected' : ''}>t2.micro - $8.47/mo</option>
                <option value="t2_small" ${resource.instanceType === 't2_small' ? 'selected' : ''}>t2.small - $16.79/mo</option>
                <option value="t2_medium" ${resource.instanceType === 't2_medium' ? 'selected' : ''}>t2.medium - $33.58/mo</option>
                <option value="t3_micro" ${resource.instanceType === 't3_micro' ? 'selected' : ''}>t3.micro - $7.59/mo</option>
                <option value="t3_small" ${resource.instanceType === 't3_small' ? 'selected' : ''}>t3.small - $15.18/mo</option>
                <option value="t3_medium" ${resource.instanceType === 't3_medium' ? 'selected' : ''}>t3.medium - $30.37/mo</option>
                <option value="m5_large" ${resource.instanceType === 'm5_large' ? 'selected' : ''}>m5.large - $70.08/mo</option>
                <option value="m5_xlarge" ${resource.instanceType === 'm5_xlarge' ? 'selected' : ''}>m5.xlarge - $140.16/mo</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'aws_rds_instance') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Instance Type</label>
              <select class="form-select" id="editInstanceType">
                <option value="db_t2_micro" ${resource.instanceType === 'db_t2_micro' ? 'selected' : ''}>db.t2.micro - $15.33/mo</option>
                <option value="db_t3_micro" ${resource.instanceType === 'db_t3_micro' ? 'selected' : ''}>db.t3.micro - $14.02/mo</option>
                <option value="db_t3_small" ${resource.instanceType === 'db_t3_small' ? 'selected' : ''}>db.t3.small - $28.47/mo</option>
                <option value="db_m5_large" ${resource.instanceType === 'db_m5_large' ? 'selected' : ''}>db.m5.large - $140.16/mo</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'aws_ebs_volume') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Volume Size (GB)</label>
              <input type="number" class="form-input" id="editVolumeSize" value="${resource.volumeSize}" min="1" placeholder="100">
              <div class="form-hint">Cost: ${(resource.volumeSize * 0.10).toFixed(2)}/mo</div>
            </div>
          `;
        } else if (resource.type === 'aws_subnet') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">CIDR Block</label>
              <input type="text" class="form-input" id="editCidrBlock" value="${resource.cidrBlock || '10.0.1.0/24'}" placeholder="e.g., 10.0.1.0/24">
              <div class="form-hint">IP address range for the subnet</div>
            </div>
            <div class="form-group">
              <label class="form-label">VPC ID</label>
              <input type="text" class="form-input" id="editVpcId" value="${resource.vpcId || ''}" placeholder="e.g., vpc-12345678 or aws_vpc.main.id">
              <div class="form-hint">VPC ID or reference (use connection for automatic reference)</div>
            </div>
            <div class="form-group">
              <label class="form-label">Availability Zone</label>
              <input type="text" class="form-input" id="editAvailabilityZone" value="${resource.availabilityZone || ''}" placeholder="e.g., us-east-1a">
              <div class="form-hint">Optional: specific AZ for the subnet</div>
            </div>
          `;
        } else if (resource.type === 'google_compute_instance') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Machine Type</label>
              <select class="form-select" id="editInstanceType">
                <option value="e2_micro" ${resource.instanceType === 'e2_micro' ? 'selected' : ''}>e2-micro - $6.11/mo</option>
                <option value="e2_small" ${resource.instanceType === 'e2_small' ? 'selected' : ''}>e2-small - $12.23/mo</option>
                <option value="e2_medium" ${resource.instanceType === 'e2_medium' ? 'selected' : ''}>e2-medium - $24.46/mo</option>
                <option value="n1_standard_1" ${resource.instanceType === 'n1_standard_1' ? 'selected' : ''}>n1-standard-1 - $24.27/mo</option>
                <option value="n1_standard_2" ${resource.instanceType === 'n1_standard_2' ? 'selected' : ''}>n1-standard-2 - $48.54/mo</option>
                <option value="n1_standard_4" ${resource.instanceType === 'n1_standard_4' ? 'selected' : ''}>n1-standard-4 - $97.09/mo</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'google_sql_database_instance') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Instance Type</label>
              <select class="form-select" id="editInstanceType">
                <option value="db_f1_micro" ${resource.instanceType === 'db_f1_micro' ? 'selected' : ''}>db-f1-micro - $7.67/mo</option>
                <option value="db_g1_small" ${resource.instanceType === 'db_g1_small' ? 'selected' : ''}>db-g1-small - $25.00/mo</option>
                <option value="db_n1_standard_1" ${resource.instanceType === 'db_n1_standard_1' ? 'selected' : ''}>db-n1-standard-1 - $51.76/mo</option>
                <option value="db_n1_standard_2" ${resource.instanceType === 'db_n1_standard_2' ? 'selected' : ''}>db-n1-standard-2 - $103.52/mo</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'google_compute_disk') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Disk Size (GB)</label>
              <input type="number" class="form-input" id="editVolumeSize" value="${resource.volumeSize}" min="1" placeholder="100">
              <div class="form-hint">Cost: ${(resource.volumeSize * 0.04).toFixed(2)}/mo</div>
            </div>
          `;
        } else if (resource.type === 'azurerm_virtual_machine') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">VM Size</label>
              <select class="form-select" id="editInstanceType">
                <option value="Standard_B1s" ${resource.instanceType === 'Standard_B1s' ? 'selected' : ''}>Standard_B1s - $7.59/mo</option>
                <option value="Standard_B2s" ${resource.instanceType === 'Standard_B2s' ? 'selected' : ''}>Standard_B2s - $30.37/mo</option>
                <option value="Standard_B2ms" ${resource.instanceType === 'Standard_B2ms' ? 'selected' : ''}>Standard_B2ms - $60.74/mo</option>
                <option value="Standard_D2s_v3" ${resource.instanceType === 'Standard_D2s_v3' ? 'selected' : ''}>Standard_D2s_v3 - $70.08/mo</option>
                <option value="Standard_D4s_v3" ${resource.instanceType === 'Standard_D4s_v3' ? 'selected' : ''}>Standard_D4s_v3 - $140.16/mo</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'azurerm_mssql_database') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">SKU Name</label>
              <select class="form-select" id="editInstanceType">
                <option value="Basic" ${resource.instanceType === 'Basic' ? 'selected' : ''}>Basic - $4.90/mo</option>
                <option value="S0" ${resource.instanceType === 'S0' ? 'selected' : ''}>S0 - $15/mo</option>
                <option value="S1" ${resource.instanceType === 'S1' ? 'selected' : ''}>S1 - $30/mo</option>
                <option value="S2" ${resource.instanceType === 'S2' ? 'selected' : ''}>S2 - $60/mo</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'azurerm_managed_disk') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Disk Size (GB)</label>
              <input type="number" class="form-input" id="editVolumeSize" value="${resource.volumeSize}" min="1" placeholder="100">
              <div class="form-hint">Cost: ${(resource.volumeSize * 0.05).toFixed(2)}/mo</div>
            </div>
          `;
        }
        // DigitalOcean Resources
        else if (resource.type === 'digitalocean_droplet') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Droplet Size</label>
              <select class="form-select" id="editInstanceType">
                <option value="s-1vcpu-1gb" ${resource.instanceType === 's-1vcpu-1gb' ? 'selected' : ''}>1 vCPU, 1GB RAM - $6/mo</option>
                <option value="s-1vcpu-2gb" ${resource.instanceType === 's-1vcpu-2gb' ? 'selected' : ''}>1 vCPU, 2GB RAM - $12/mo</option>
                <option value="s-2vcpu-2gb" ${resource.instanceType === 's-2vcpu-2gb' ? 'selected' : ''}>2 vCPU, 2GB RAM - $18/mo</option>
                <option value="s-2vcpu-4gb" ${resource.instanceType === 's-2vcpu-4gb' ? 'selected' : ''}>2 vCPU, 4GB RAM - $24/mo</option>
                <option value="s-4vcpu-8gb" ${resource.instanceType === 's-4vcpu-8gb' ? 'selected' : ''}>4 vCPU, 8GB RAM - $48/mo</option>
                <option value="s-8vcpu-16gb" ${resource.instanceType === 's-8vcpu-16gb' ? 'selected' : ''}>8 vCPU, 16GB RAM - $96/mo</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Region</label>
              <input type="text" class="form-input" id="editRegion" value="${resource.region || 'nyc3'}" placeholder="e.g., nyc3, sfo3, fra1">
              <div class="form-hint">DigitalOcean datacenter region</div>
            </div>
            <div class="form-group">
              <label class="form-label">Image</label>
              <input type="text" class="form-input" id="editImage" value="${resource.image || 'ubuntu-22-04-x64'}" placeholder="e.g., ubuntu-22-04-x64">
              <div class="form-hint">OS image slug</div>
            </div>
          `;
        } else if (resource.type === 'digitalocean_database_cluster') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Database Size</label>
              <select class="form-select" id="editInstanceType">
                <option value="db-s-1vcpu-1gb" ${resource.instanceType === 'db-s-1vcpu-1gb' ? 'selected' : ''}>1 vCPU, 1GB RAM - $15/mo</option>
                <option value="db-s-2vcpu-4gb" ${resource.instanceType === 'db-s-2vcpu-4gb' ? 'selected' : ''}>2 vCPU, 4GB RAM - $60/mo</option>
                <option value="db-s-4vcpu-8gb" ${resource.instanceType === 'db-s-4vcpu-8gb' ? 'selected' : ''}>4 vCPU, 8GB RAM - $120/mo</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Engine</label>
              <select class="form-select" id="editEngine">
                <option value="pg" ${resource.engine === 'pg' ? 'selected' : ''}>PostgreSQL</option>
                <option value="mysql" ${resource.engine === 'mysql' ? 'selected' : ''}>MySQL</option>
                <option value="redis" ${resource.engine === 'redis' ? 'selected' : ''}>Redis</option>
                <option value="mongodb" ${resource.engine === 'mongodb' ? 'selected' : ''}>MongoDB</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'digitalocean_volume') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Volume Size (GB)</label>
              <input type="number" class="form-input" id="editVolumeSize" value="${resource.volumeSize || 100}" min="1" placeholder="100">
              <div class="form-hint">Cost: $${((resource.volumeSize || 100) * 0.10).toFixed(2)}/mo</div>
            </div>
          `;
        } else if (resource.type === 'digitalocean_domain') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Domain Name</label>
              <input type="text" class="form-input" id="editDomain" value="${resource.domain || ''}" placeholder="e.g., example.com">
              <div class="form-hint">Your domain name</div>
            </div>
          `;
        } else if (resource.type === 'digitalocean_record') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Record Type</label>
              <select class="form-select" id="editRecordType">
                <option value="A" ${resource.recordType === 'A' ? 'selected' : ''}>A</option>
                <option value="AAAA" ${resource.recordType === 'AAAA' ? 'selected' : ''}>AAAA</option>
                <option value="CNAME" ${resource.recordType === 'CNAME' ? 'selected' : ''}>CNAME</option>
                <option value="MX" ${resource.recordType === 'MX' ? 'selected' : ''}>MX</option>
                <option value="TXT" ${resource.recordType === 'TXT' ? 'selected' : ''}>TXT</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Record Name</label>
              <input type="text" class="form-input" id="editRecordName" value="${resource.recordName || '@'}" placeholder="e.g., www, @">
              <div class="form-hint">Subdomain or @ for root</div>
            </div>
            <div class="form-group">
              <label class="form-label">Record Value</label>
              <input type="text" class="form-input" id="editRecordValue" value="${resource.recordValue || ''}" placeholder="e.g., 192.0.2.1">
              <div class="form-hint">IP address or hostname</div>
            </div>
          `;
        } else if (resource.type === 'digitalocean_spaces_bucket') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Bucket Name</label>
              <input type="text" class="form-input" id="editBucketName" value="${resource.bucketName || resource.name}" placeholder="e.g., my-bucket">
              <div class="form-hint">Spaces bucket name (must be unique)</div>
            </div>
            <div class="form-group">
              <label class="form-label">ACL</label>
              <select class="form-select" id="editAcl">
                <option value="private" ${resource.acl === 'private' ? 'selected' : ''}>Private</option>
                <option value="public-read" ${resource.acl === 'public-read' ? 'selected' : ''}>Public Read</option>
              </select>
            </div>
          `;
        } else if (resource.type === 'digitalocean_vpc') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">IP Range (CIDR)</label>
              <input type="text" class="form-input" id="editIpRange" value="${resource.ipRange || '10.10.10.0/24'}" placeholder="e.g., 10.10.10.0/24">
              <div class="form-hint">VPC IP address range</div>
            </div>
          `;
        } else if (resource.type === 'digitalocean_project') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-input" id="editDescription" rows="2" placeholder="Project description">${resource.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Purpose</label>
              <select class="form-select" id="editPurpose">
                <option value="Web Application" ${resource.purpose === 'Web Application' ? 'selected' : ''}>Web Application</option>
                <option value="Service or API" ${resource.purpose === 'Service or API' ? 'selected' : ''}>Service or API</option>
                <option value="Mobile App" ${resource.purpose === 'Mobile App' ? 'selected' : ''}>Mobile App</option>
                <option value="Machine Learning" ${resource.purpose === 'Machine Learning' ? 'selected' : ''}>Machine Learning</option>
                <option value="IoT" ${resource.purpose === 'IoT' ? 'selected' : ''}>IoT</option>
                <option value="Other" ${resource.purpose === 'Other' ? 'selected' : ''}>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Environment</label>
              <select class="form-select" id="editEnvironment">
                <option value="Production" ${resource.environment === 'Production' ? 'selected' : ''}>Production</option>
                <option value="Staging" ${resource.environment === 'Staging' ? 'selected' : ''}>Staging</option>
                <option value="Development" ${resource.environment === 'Development' ? 'selected' : ''}>Development</option>
              </select>
            </div>
          `;
        }
        // Kubernetes Resources
        else if (resource.type === 'kubernetes_ingress') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Host</label>
              <input type="text" class="form-input" id="editHost" value="${resource.host || ''}" placeholder="e.g., example.com">
              <div class="form-hint">Domain name for the ingress</div>
            </div>
            <div class="form-group">
              <label class="form-label">Path</label>
              <input type="text" class="form-input" id="editPath" value="${resource.path || '/'}" placeholder="/">
            </div>
            <div class="form-group">
              <label class="form-label">Service Name</label>
              <input type="text" class="form-input" id="editServiceName" value="${resource.serviceName || ''}" placeholder="e.g., my-service">
            </div>
            <div class="form-group">
              <label class="form-label">Service Port</label>
              <input type="number" class="form-input" id="editServicePort" value="${resource.servicePort || 80}" placeholder="80">
            </div>
            <div class="form-group">
              <label class="form-label">Ingress Class</label>
              <input type="text" class="form-input" id="editIngressClass" value="${resource.ingressClass || 'nginx'}" placeholder="nginx">
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="editTlsEnabled" ${resource.tlsEnabled ? 'checked' : ''}> Enable TLS
              </label>
            </div>
            <div class="form-group">
              <label class="form-label">TLS Secret Name</label>
              <input type="text" class="form-input" id="editTlsSecret" value="${resource.tlsSecret || ''}" placeholder="tls-secret">
            </div>
          `;
        } else if (resource.type === 'kubernetes_ingress_v1') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Host</label>
              <input type="text" class="form-input" id="editHost" value="${resource.host || ''}" placeholder="e.g., example.com">
              <div class="form-hint">Domain name for the ingress</div>
            </div>
            <div class="form-group">
              <label class="form-label">Path</label>
              <input type="text" class="form-input" id="editPath" value="${resource.path || '/'}" placeholder="/">
            </div>
            <div class="form-group">
              <label class="form-label">Path Type</label>
              <select class="form-select" id="editPathType">
                <option value="Prefix" ${resource.pathType === 'Prefix' ? 'selected' : ''}>Prefix</option>
                <option value="Exact" ${resource.pathType === 'Exact' ? 'selected' : ''}>Exact</option>
                <option value="ImplementationSpecific" ${resource.pathType === 'ImplementationSpecific' ? 'selected' : ''}>ImplementationSpecific</option>
              </select>
              <div class="form-hint">How the path should be matched</div>
            </div>
            <div class="form-group">
              <label class="form-label">Service Name</label>
              <input type="text" class="form-input" id="editServiceName" value="${resource.serviceName || ''}" placeholder="e.g., my-service">
            </div>
            <div class="form-group">
              <label class="form-label">Service Port</label>
              <input type="number" class="form-input" id="editServicePort" value="${resource.servicePort || 80}" placeholder="80">
            </div>
            <div class="form-group">
              <label class="form-label">Ingress Class Name</label>
              <input type="text" class="form-input" id="editIngressClass" value="${resource.ingressClass || 'nginx'}" placeholder="nginx">
              <div class="form-hint">V1 uses ingress_class_name instead of annotation</div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="editTlsEnabled" ${resource.tlsEnabled ? 'checked' : ''}> Enable TLS
              </label>
            </div>
            <div class="form-group">
              <label class="form-label">TLS Secret Name</label>
              <input type="text" class="form-input" id="editTlsSecret" value="${resource.tlsSecret || ''}" placeholder="tls-secret">
            </div>
          `;
        } else if (resource.type === 'kubernetes_deployment') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Container Image</label>
              <input type="text" class="form-input" id="editImage" value="${resource.image || 'nginx:latest'}" placeholder="nginx:latest">
            </div>
            <div class="form-group">
              <label class="form-label">Replicas</label>
              <input type="number" class="form-input" id="editReplicas" value="${resource.replicas || 3}" min="1" placeholder="3">
            </div>
            <div class="form-group">
              <label class="form-label">Container Port</label>
              <input type="number" class="form-input" id="editContainerPort" value="${resource.containerPort || 80}" placeholder="80">
            </div>
          `;
        } else if (resource.type === 'kubernetes_service') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Service Type</label>
              <select class="form-select" id="editServiceType">
                <option value="ClusterIP" ${resource.serviceType === 'ClusterIP' ? 'selected' : ''}>ClusterIP</option>
                <option value="NodePort" ${resource.serviceType === 'NodePort' ? 'selected' : ''}>NodePort</option>
                <option value="LoadBalancer" ${resource.serviceType === 'LoadBalancer' ? 'selected' : ''}>LoadBalancer</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Port</label>
              <input type="number" class="form-input" id="editPort" value="${resource.port || 80}" placeholder="80">
            </div>
            <div class="form-group">
              <label class="form-label">Target Port</label>
              <input type="number" class="form-input" id="editTargetPort" value="${resource.targetPort || 80}" placeholder="80">
            </div>
            <div class="form-group">
              <label class="form-label">Selector App</label>
              <input type="text" class="form-input" id="editApp" value="${resource.app || resource.name}" placeholder="app-name">
            </div>
          `;
        } else if (resource.type === 'kubernetes_persistent_volume_claim') {
          formHTML += `
            <div class="form-group">
              <label class="form-label">Storage Size</label>
              <input type="text" class="form-input" id="editStorage" value="${resource.storage || '10Gi'}" placeholder="10Gi">
              <div class="form-hint">e.g., 10Gi, 100Gi, 1Ti</div>
            </div>
          `;
        }
      }

      formHTML += `
        <div class="modal-actions">
          <button class="btn btn-primary" style="flex: 1;" onclick="saveEdit(${numId})">üíæ Save Changes</button>
          <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      `;

      form.innerHTML = formHTML;
      modal.classList.add('active');
    }

    function saveEdit(id) {
      const numId = typeof id === 'string' ? parseInt(id) : id;
      const resource = resources.find(r => r.id === numId);
      if (!resource) return;

      resource.name = document.getElementById('editName').value;
      resource.displayName = document.getElementById('editDisplayName').value;
      
      if (resource.isModule) {
        const sourceInput = document.getElementById('editModuleSource');
        const versionInput = document.getElementById('editModuleVersion');
        if (sourceInput) resource.moduleSource = sourceInput.value;
        if (versionInput) resource.moduleVersion = versionInput.value;
      } else if (resource.isData) {
        const filterInput = document.getElementById('editDataFilter');
        if (filterInput) {
          try {
            resource.dataFilter = JSON.parse(filterInput.value);
          } catch (e) {
            alert('Invalid JSON in filter field');
            return;
          }
        }
      } else {
        if (resource.type === 'aws_instance') {
          resource.ami = document.getElementById('editAmi').value;
          resource.instanceType = document.getElementById('editInstanceType').value;
        } else if (resource.type === 'aws_rds_instance') {
          resource.instanceType = document.getElementById('editInstanceType').value;
        } else if (resource.type === 'aws_ebs_volume') {
          resource.volumeSize = parseInt(document.getElementById('editVolumeSize').value) || 0;
        } else if (resource.type === 'aws_subnet') {
          const cidrBlockInput = document.getElementById('editCidrBlock');
          const vpcIdInput = document.getElementById('editVpcId');
          const azInput = document.getElementById('editAvailabilityZone');
          if (cidrBlockInput) resource.cidrBlock = cidrBlockInput.value;
          if (vpcIdInput) resource.vpcId = vpcIdInput.value;
          if (azInput) resource.availabilityZone = azInput.value;
        } else if (resource.type === 'google_compute_instance' || resource.type === 'google_sql_database_instance') {
          resource.instanceType = document.getElementById('editInstanceType').value;
        } else if (resource.type === 'google_compute_disk') {
          resource.volumeSize = parseInt(document.getElementById('editVolumeSize').value) || 0;
        } else if (resource.type === 'azurerm_virtual_machine' || resource.type === 'azurerm_mssql_database') {
          resource.instanceType = document.getElementById('editInstanceType').value;
        } else if (resource.type === 'azurerm_managed_disk') {
          resource.volumeSize = parseInt(document.getElementById('editVolumeSize').value) || 0;
        }
        // DigitalOcean Resources
        else if (resource.type === 'digitalocean_droplet') {
          resource.instanceType = document.getElementById('editInstanceType').value;
          const regionInput = document.getElementById('editRegion');
          const imageInput = document.getElementById('editImage');
          if (regionInput) resource.region = regionInput.value;
          if (imageInput) resource.image = imageInput.value;
        } else if (resource.type === 'digitalocean_database_cluster') {
          resource.instanceType = document.getElementById('editInstanceType').value;
          const engineInput = document.getElementById('editEngine');
          if (engineInput) resource.engine = engineInput.value;
        } else if (resource.type === 'digitalocean_volume') {
          resource.volumeSize = parseInt(document.getElementById('editVolumeSize').value) || 100;
        } else if (resource.type === 'digitalocean_domain') {
          const domainInput = document.getElementById('editDomain');
          if (domainInput) resource.domain = domainInput.value;
        } else if (resource.type === 'digitalocean_record') {
          const recordTypeInput = document.getElementById('editRecordType');
          const recordNameInput = document.getElementById('editRecordName');
          const recordValueInput = document.getElementById('editRecordValue');
          if (recordTypeInput) resource.recordType = recordTypeInput.value;
          if (recordNameInput) resource.recordName = recordNameInput.value;
          if (recordValueInput) resource.recordValue = recordValueInput.value;
        } else if (resource.type === 'digitalocean_spaces_bucket') {
          const bucketNameInput = document.getElementById('editBucketName');
          const aclInput = document.getElementById('editAcl');
          if (bucketNameInput) resource.bucketName = bucketNameInput.value;
          if (aclInput) resource.acl = aclInput.value;
        } else if (resource.type === 'digitalocean_vpc') {
          const ipRangeInput = document.getElementById('editIpRange');
          if (ipRangeInput) resource.ipRange = ipRangeInput.value;
        } else if (resource.type === 'digitalocean_project') {
          const descInput = document.getElementById('editDescription');
          const purposeInput = document.getElementById('editPurpose');
          const envInput = document.getElementById('editEnvironment');
          if (descInput) resource.description = descInput.value;
          if (purposeInput) resource.purpose = purposeInput.value;
          if (envInput) resource.environment = envInput.value;
        }
        // Kubernetes Resources
        else if (resource.type === 'kubernetes_ingress') {
          const hostInput = document.getElementById('editHost');
          const pathInput = document.getElementById('editPath');
          const serviceNameInput = document.getElementById('editServiceName');
          const servicePortInput = document.getElementById('editServicePort');
          const ingressClassInput = document.getElementById('editIngressClass');
          const tlsEnabledInput = document.getElementById('editTlsEnabled');
          const tlsSecretInput = document.getElementById('editTlsSecret');
          if (hostInput) resource.host = hostInput.value;
          if (pathInput) resource.path = pathInput.value;
          if (serviceNameInput) resource.serviceName = serviceNameInput.value;
          if (servicePortInput) resource.servicePort = parseInt(servicePortInput.value);
          if (ingressClassInput) resource.ingressClass = ingressClassInput.value;
          if (tlsEnabledInput) resource.tlsEnabled = tlsEnabledInput.checked;
          if (tlsSecretInput) resource.tlsSecret = tlsSecretInput.value;
        } else if (resource.type === 'kubernetes_ingress_v1') {
          const hostInput = document.getElementById('editHost');
          const pathInput = document.getElementById('editPath');
          const pathTypeInput = document.getElementById('editPathType');
          const serviceNameInput = document.getElementById('editServiceName');
          const servicePortInput = document.getElementById('editServicePort');
          const ingressClassInput = document.getElementById('editIngressClass');
          const tlsEnabledInput = document.getElementById('editTlsEnabled');
          const tlsSecretInput = document.getElementById('editTlsSecret');
          if (hostInput) resource.host = hostInput.value;
          if (pathInput) resource.path = pathInput.value;
          if (pathTypeInput) resource.pathType = pathTypeInput.value;
          if (serviceNameInput) resource.serviceName = serviceNameInput.value;
          if (servicePortInput) resource.servicePort = parseInt(servicePortInput.value);
          if (ingressClassInput) resource.ingressClass = ingressClassInput.value;
          if (tlsEnabledInput) resource.tlsEnabled = tlsEnabledInput.checked;
          if (tlsSecretInput) resource.tlsSecret = tlsSecretInput.value;
        } else if (resource.type === 'kubernetes_deployment') {
          const imageInput = document.getElementById('editImage');
          const replicasInput = document.getElementById('editReplicas');
          const containerPortInput = document.getElementById('editContainerPort');
          if (imageInput) resource.image = imageInput.value;
          if (replicasInput) resource.replicas = parseInt(replicasInput.value);
          if (containerPortInput) resource.containerPort = parseInt(containerPortInput.value);
        } else if (resource.type === 'kubernetes_service') {
          const serviceTypeInput = document.getElementById('editServiceType');
          const portInput = document.getElementById('editPort');
          const targetPortInput = document.getElementById('editTargetPort');
          const appInput = document.getElementById('editApp');
          if (serviceTypeInput) resource.serviceType = serviceTypeInput.value;
          if (portInput) resource.port = parseInt(portInput.value);
          if (targetPortInput) resource.targetPort = parseInt(targetPortInput.value);
          if (appInput) resource.app = appInput.value;
        } else if (resource.type === 'kubernetes_persistent_volume_claim') {
          const storageInput = document.getElementById('editStorage');
          if (storageInput) resource.storage = storageInput.value;
        }
      }

      closeEditModal();
      updateUI();
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    function exportCode() {
      const code = document.getElementById('codeOutput').textContent;
      const blob = new Blob([code], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'infrastructure.tf';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importTerraformFile(event) {
      const file = event.target.files[0];
      if (!file) {
        console.log('No file selected');
        return;
      }

      console.log('Reading file:', file.name, 'size:', file.size, 'type:', file.type);

      const reader = new FileReader();
      reader.onload = (e) => {
        const tfCode = e.target.result;
        console.log('File loaded successfully');
        console.log('Length:', tfCode.length);
        console.log('First 500 characters:', tfCode.substring(0, 500));
        console.log('Contains "resource"?', tfCode.includes('resource'));
        console.log('Line count:', tfCode.split('\n').length);

        // Show the actual content being parsed
        if (tfCode.length === 0) {
          alert('File is empty!');
          return;
        }

        parseTerraformCode(tfCode);
      };
      reader.onerror = (e) => {
        console.error('Error reading file:', e);
        alert('Error reading file');
      };
      reader.readAsText(file);

      // Reset the input so the same file can be imported again
      event.target.value = '';
    }

    function parseTerraformCode(code) {
      console.log('=== Starting Terraform Import ===');
      console.log('Code preview:', code.substring(0, 200) + '...');

      // Clear existing resources
      resources = [];
      connections = [];
      positions = {};

      // Parse by counting braces line by line
      const lines = code.split('\n');
      let inResource = false;
      let braceCount = 0;
      let currentType = '';
      let currentName = '';
      let currentContent = '';

      // Get actual canvas dimensions
      const canvas = document.getElementById('canvas');
      const canvasRect = canvas.getBoundingClientRect();
      const CANVAS_WIDTH = canvasRect.width;
      const CANVAS_HEIGHT = 1200; // Fixed height from CSS
      const RESOURCE_WIDTH = 200;
      const RESOURCE_HEIGHT = 120; // Approximate height of resource card
      const MARGIN = 50;
      const SPACING_X = 220; // Space between resources horizontally
      const SPACING_Y = 140; // Space between resources vertically

      console.log(`Canvas dimensions: ${CANVAS_WIDTH}px x ${CANVAS_HEIGHT}px`);

      let xOffset = MARGIN;
      let yOffset = MARGIN;
      let resourcesInRow = 0;
      let importedCount = 0;
      const maxResourcesPerRow = Math.floor((CANVAS_WIDTH - MARGIN * 2) / SPACING_X);
      console.log(`Max resources per row: ${maxResourcesPerRow}`);

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Start of resource block
        if (!inResource) {
          const resourceMatch = line.match(/resource\s+"([^"]+)"\s+"([^"]+)"\s*\{/);
          if (resourceMatch) {
            inResource = true;
            currentType = resourceMatch[1];
            currentName = resourceMatch[2];
            currentContent = '';
            braceCount = 1;
            console.log(`Found resource on line ${i + 1}: ${currentType} "${currentName}"`);

            // Check if there's content after the opening brace on the same line
            const afterBrace = line.substring(line.indexOf('{') + 1).trim();
            if (afterBrace) {
              currentContent += afterBrace + '\n';
              // Count any additional braces on this line
              braceCount += (afterBrace.match(/\{/g) || []).length;
              braceCount -= (afterBrace.match(/\}/g) || []).length;

              if (braceCount === 0) {
                // Resource block ended on same line (unlikely but possible)
                inResource = false;
              }
            }
            continue;
          }
        }

        if (inResource) {
          // Add line to content
          currentContent += line + '\n';

          // Count braces in this line
          const openBraces = (line.match(/\{/g) || []).length;
          const closeBraces = (line.match(/\}/g) || []).length;
          braceCount += openBraces;
          braceCount -= closeBraces;

          console.log(`Line ${i + 1}: braces {${openBraces} }${closeBraces}, depth: ${braceCount}`);

          // End of resource block
          if (braceCount === 0) {
            // Find matching template - only check current cloud provider
            let template = null;
            let foundProvider = null;

            // First, determine which provider this resource belongs to
            for (const provider in cloudResourceTemplates) {
              const providerTemplates = cloudResourceTemplates[provider];
              const allTemplates = Object.values(providerTemplates).flat();
              const foundTemplate = allTemplates.find(t => t.type === currentType);
              if (foundTemplate) {
                template = foundTemplate;
                foundProvider = provider;
                console.log(`Found template for ${currentType} in provider ${provider}`);
                break;
              }
            }

            // Check if the resource's provider matches the currently selected provider
            if (template && foundProvider !== currentCloudProvider) {
              console.log(`Skipping ${currentType} - belongs to ${foundProvider} but current provider is ${currentCloudProvider}`);
              alert(`Cannot import ${currentType} resource. This resource belongs to ${foundProvider} provider, but you have ${currentCloudProvider} selected. Please switch to the correct cloud provider first.`);
              template = null; // Skip this resource
            }

            if (template) {
              // Check if resource will fit in canvas bounds BEFORE creating it
              if (yOffset + RESOURCE_HEIGHT > CANVAS_HEIGHT - MARGIN) {
                console.warn(`Resource ${currentName} would exceed canvas height (y=${yOffset}), stopping import`);
                alert(`Reached canvas limit. Imported ${importedCount} resources. Remaining resources skipped to keep them within canvas bounds.`);
                // Stop importing more resources to avoid overflow
                break;
              }

              const id = `resource-${nextId++}`;

              // Parse instance type based on provider
              let instanceType = null;

              // AWS instance types
              if (currentType === 'aws_instance') {
                const instanceMatch = currentContent.match(/instance_type\s*=\s*"([^"]+)"/);
                if (instanceMatch) instanceType = instanceMatch[1].replace('.', '_');
              } else if (currentType === 'aws_rds_instance') {
                const instanceMatch = currentContent.match(/instance_class\s*=\s*"([^"]+)"/);
                if (instanceMatch) instanceType = instanceMatch[1].replace('.', '_');
              }
              // GCP instance types
              else if (currentType === 'google_compute_instance') {
                const machineMatch = currentContent.match(/machine_type\s*=\s*"([^"]+)"/);
                if (machineMatch) instanceType = machineMatch[1].replace('-', '_');
              } else if (currentType === 'google_sql_database_instance') {
                const tierMatch = currentContent.match(/tier\s*=\s*"([^"]+)"/);
                if (tierMatch) instanceType = tierMatch[1].replace('-', '_');
              }
              // Azure instance types
              else if (currentType === 'azurerm_virtual_machine') {
                const sizeMatch = currentContent.match(/vm_size\s*=\s*"([^"]+)"/);
                if (sizeMatch) instanceType = sizeMatch[1];
              } else if (currentType === 'azurerm_mssql_database') {
                const skuMatch = currentContent.match(/sku_name\s*=\s*"([^"]+)"/);
                if (skuMatch) instanceType = skuMatch[1];
              }

              // Parse AMI for AWS
              let ami = '';
              if (currentType === 'aws_instance') {
                const amiMatch = currentContent.match(/ami\s*=\s*"([^"]+)"/);
                if (amiMatch) ami = amiMatch[1];
              }

              // Parse volume size
              let volumeSize = 0;
              if (currentType === 'aws_ebs_volume') {
                const sizeMatch = currentContent.match(/size\s*=\s*(\d+)/);
                if (sizeMatch) volumeSize = parseInt(sizeMatch[1]);
              }

              // Parse Kubernetes Ingress properties
              let host = '';
              let path = '/';
              let pathType = 'Prefix';
              let serviceName = '';
              let servicePort = 80;
              let ingressClass = '';
              let tlsEnabled = false;
              let tlsSecret = '';

              if (currentType === 'kubernetes_ingress' || currentType === 'kubernetes_ingress_v1') {
                console.log('==== Parsing Kubernetes Ingress ====');
                console.log('Resource type:', currentType);
                console.log('Resource name:', currentName);
                console.log('Content length:', currentContent.length);
                console.log('Full content:');
                console.log(currentContent);

                // Parse host from rule block
                const hostMatch = currentContent.match(/host\s*=\s*"([^"]+)"/);
                console.log('Host regex test:', hostMatch);
                if (hostMatch) {
                  host = hostMatch[1];
                  console.log('‚úì Found host:', host);
                } else {
                  console.log('‚úó No host found');
                }

                // Parse path
                const pathMatch = currentContent.match(/path\s*=\s*"([^"]+)"/);
                if (pathMatch) {
                  path = pathMatch[1];
                  console.log('Found path:', path);
                }

                // Parse path_type (v1 only)
                if (currentType === 'kubernetes_ingress_v1') {
                  const pathTypeMatch = currentContent.match(/path_type\s*=\s*"([^"]+)"/);
                  if (pathTypeMatch) {
                    pathType = pathTypeMatch[1];
                    console.log('Found path_type:', pathType);
                  }
                }

                // Parse service name - different for v1 vs legacy
                if (currentType === 'kubernetes_ingress_v1') {
                  // V1 uses service { name = "..." } - need multiline and more flexible regex
                  const serviceNameMatch = currentContent.match(/service\s*\{[\s\S]*?name\s*=\s*"([^"]+)"/);
                  if (serviceNameMatch) {
                    serviceName = serviceNameMatch[1];
                    console.log('Found service name (v1):', serviceName);
                  }
                } else {
                  // Legacy uses service_name = "..."
                  const serviceNameMatch = currentContent.match(/service_name\s*=\s*"([^"]+)"/);
                  if (serviceNameMatch) {
                    serviceName = serviceNameMatch[1];
                    console.log('Found service name (legacy):', serviceName);
                  }
                }

                // Parse service port - different for v1 vs legacy
                if (currentType === 'kubernetes_ingress_v1') {
                  // V1 uses port { number = 80 } - need multiline regex
                  const servicePortMatch = currentContent.match(/port\s*\{[\s\S]*?number\s*=\s*(\d+)/);
                  if (servicePortMatch) {
                    servicePort = parseInt(servicePortMatch[1]);
                    console.log('Found service port (v1):', servicePort);
                  }
                } else {
                  // Legacy uses service_port = 80
                  const servicePortMatch = currentContent.match(/service_port\s*=\s*(\d+)/);
                  if (servicePortMatch) {
                    servicePort = parseInt(servicePortMatch[1]);
                    console.log('Found service port (legacy):', servicePort);
                  }
                }

                // Parse ingress class - different for v1 vs legacy
                if (currentType === 'kubernetes_ingress_v1') {
                  // V1 uses ingress_class_name = "nginx"
                  const ingressClassMatch = currentContent.match(/ingress_class_name\s*=\s*"([^"]+)"/);
                  if (ingressClassMatch) {
                    ingressClass = ingressClassMatch[1];
                    console.log('Found ingress_class_name:', ingressClass);
                  }
                } else {
                  // Legacy uses annotation
                  const ingressClassMatch = currentContent.match(/"kubernetes\.io\/ingress\.class"\s*=\s*"([^"]+)"/);
                  if (ingressClassMatch) {
                    ingressClass = ingressClassMatch[1];
                    console.log('Found ingress class annotation:', ingressClass);
                  }
                }

                // Parse TLS
                if (currentContent.includes('tls {') || currentContent.includes('tls{')) {
                  tlsEnabled = true;
                  const tlsSecretMatch = currentContent.match(/secret_name\s*=\s*"([^"]+)"/);
                  if (tlsSecretMatch) {
                    tlsSecret = tlsSecretMatch[1];
                    console.log('Found TLS secret:', tlsSecret);
                  }
                  console.log('TLS enabled');
                }

                console.log('Final parsed values:', { host, path, pathType, serviceName, servicePort, ingressClass, tlsEnabled, tlsSecret });

                // Show alert if nothing was parsed to help debug
                if (!host && !serviceName && !ingressClass) {
                  console.warn('WARNING: No ingress properties were parsed!');
                  alert(`Ingress import: No properties found in resource.\n\nCheck console (F12) for full content.\n\nContent length: ${currentContent.length} chars`);
                }
              }

              const resource = {
                id,
                type: currentType,
                name: currentName,
                displayName: template.name,
                icon: template.icon,
                color: template.color,
                instanceType: instanceType || template.defaultInstance,
                volumeSize: volumeSize || template.defaultSize || 0,
                ami: ami || (currentType === 'aws_instance' ? 'ami-04b3c39a8a1c62b76' : '')
              };

              // Add Kubernetes Ingress properties only if they were parsed
              if (currentType === 'kubernetes_ingress' || currentType === 'kubernetes_ingress_v1') {
                if (host) resource.host = host;
                if (path) resource.path = path;
                if (pathType) resource.pathType = pathType;
                if (serviceName) resource.serviceName = serviceName;
                if (servicePort) resource.servicePort = servicePort;
                if (ingressClass) resource.ingressClass = ingressClass;
                if (tlsEnabled) resource.tlsEnabled = tlsEnabled;
                if (tlsSecret) resource.tlsSecret = tlsSecret;
              }

              resources.push(resource);
              positions[id] = { x: xOffset, y: yOffset };
              importedCount++;

              console.log(`Imported resource at (${xOffset}, ${yOffset}):`, resource);

              // Layout resources in a grid
              resourcesInRow++;
              xOffset += SPACING_X;

              // Move to next row if we've hit the limit or would exceed canvas width
              if (resourcesInRow >= maxResourcesPerRow || xOffset + RESOURCE_WIDTH > CANVAS_WIDTH - MARGIN) {
                resourcesInRow = 0;
                xOffset = MARGIN;
                yOffset += SPACING_Y;
              }
            } else {
              console.log(`Template not found for type: ${currentType}`);
            }

            inResource = false;
          }
        }
      }

      updateUI();

      if (importedCount > 0) {
        alert(`Successfully imported ${importedCount} resources from Terraform file!`);
      } else {
        alert('No recognized resources found in Terraform file. Make sure the file contains valid resource blocks.');
      }
    }

    function zoomIn() {
      zoom = Math.min(2, zoom + 0.1);
      updateZoom();
    }

    function zoomOut() {
      zoom = Math.max(0.5, zoom - 0.1);
      updateZoom();
    }

    function updateZoom() {
      document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
      const canvas = document.getElementById('canvas');
      canvas.style.backgroundSize = (20 * zoom) + 'px ' + (20 * zoom) + 'px';
      renderCanvas();
    }

    // Project State Management
    let currentProjectId = null;

    async function saveProjectState() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        alert('Please log in to save projects');
        return;
      }

      if (!currentProjectId) {
        alert('Please open a project first to save state');
        return;
      }

      try {
        const terraformCode = document.getElementById('codeOutput').textContent;

        const response = await fetch(`/api/projects/${currentProjectId}/save`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            resources: resources,
            connections: connections,
            positions: positions,
            terraform_code: terraformCode
          })
        });

        if (response.ok) {
          const data = await response.json();
          alert(`Project saved successfully! Version: ${data.version.version_number}`);
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to save project');
        }
      } catch (error) {
        console.error('Save error:', error);
        alert('Error saving project');
      }
    }

    async function loadProjectState() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        alert('Please log in to load projects');
        return;
      }

      if (!currentProjectId) {
        alert('Please open a project first to load state');
        return;
      }

      try {
        const response = await fetch(`/api/projects/${currentProjectId}/load`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.state.resources.length === 0) {
            alert('No saved state found for this project');
            return;
          }

          // Load the state
          resources = data.state.resources || [];
          connections = data.state.connections || [];
          positions = data.state.positions || {};

          // Update UI
          updateUI();
          renderCanvas();

          alert(`Project loaded successfully! Version: ${data.version || 1}`);
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to load project');
        }
      } catch (error) {
        console.error('Load error:', error);
        alert('Error loading project');
      }
    }

    async function showVersionHistory() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        alert('Please log in to view version history');
        return;
      }

      if (!currentProjectId) {
        alert('Please open a project first');
        return;
      }

      try {
        const response = await fetch(`/api/projects/${currentProjectId}/versions`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          const versions = data.versions || [];

          if (versions.length === 0) {
            alert('No versions saved yet. Save your project to create the first version.');
            return;
          }

          // Populate version list
          const versionList = document.getElementById('versionList');
          versionList.innerHTML = '';

          versions.forEach(version => {
            const versionItem = document.createElement('div');
            versionItem.style.cssText = `
              padding: 16px;
              margin-bottom: 12px;
              border: 2px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
            `;
            versionItem.onmouseenter = () => {
              versionItem.style.borderColor = '#667eea';
              versionItem.style.background = '#f9fafb';
            };
            versionItem.onmouseleave = () => {
              versionItem.style.borderColor = '#e5e7eb';
              versionItem.style.background = 'white';
            };
            versionItem.onclick = () => loadSpecificVersion(version.version_number);

            const date = new Date(version.created_at);
            const dateStr = date.toLocaleString();

            versionItem.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                    Version ${version.version_number}
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">
                    ${dateStr} ‚Ä¢ ${version.resource_count} resources
                  </div>
                </div>
                <button onclick="loadSpecificVersion(${version.version_number}); event.stopPropagation();"
                        style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                  Load
                </button>
              </div>
            `;

            versionList.appendChild(versionItem);
          });

          // Show modal
          document.getElementById('versionModal').classList.add('active');
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to load version history');
        }
      } catch (error) {
        console.error('Version history error:', error);
        alert('Error loading version history');
      }
    }

    async function loadSpecificVersion(versionNumber) {
      const token = localStorage.getItem('access_token');
      if (!token) return;

      if (!currentProjectId) return;

      try {
        const response = await fetch(`/api/projects/${currentProjectId}/versions/${versionNumber}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();

          // Load the state
          resources = data.state.resources || [];
          connections = data.state.connections || [];
          positions = data.state.positions || {};

          // Update UI
          updateUI();
          renderCanvas();

          // Close modal
          closeVersionModal();

          alert(`Version ${versionNumber} loaded successfully!`);
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to load version');
        }
      } catch (error) {
        console.error('Load version error:', error);
        alert('Error loading version');
      }
    }

    function closeVersionModal() {
      document.getElementById('versionModal').classList.remove('active');
    }

    // AI Designer Functions
    function showAIDesigner() {
      const modal = document.getElementById('aiDesignerModal');
      modal.style.display = 'flex';

      // Set default provider to current canvas provider
      document.getElementById('aiProviderSelect').value = currentCloudProvider;

      // Clear previous inputs/results
      document.getElementById('aiPromptInput').value = '';
      document.getElementById('aiDesignResult').style.display = 'none';
      document.getElementById('aiDesignContent').textContent = '';
    }

    function closeAIDesignerModal() {
      document.getElementById('aiDesignerModal').style.display = 'none';
    }

    let currentAIDesign = null; // Store the parsed AI design

    async function generateAIDesign() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        alert('Please log in to use AI features');
        return;
      }

      const prompt = document.getElementById('aiPromptInput').value.trim();
      const provider = document.getElementById('aiProviderSelect').value;

      if (!prompt) {
        alert('Please describe what you want to build');
        return;
      }

      const generateBtn = document.getElementById('generateDesignBtn');
      const resultDiv = document.getElementById('aiDesignResult');
      const contentPre = document.getElementById('aiDesignContent');

      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      // Show result area immediately
      resultDiv.style.display = 'block';
      contentPre.textContent = '';

      // Hide apply button until we have a valid design
      const applyBtn = document.getElementById('applyDesignBtn');
      if (applyBtn) applyBtn.style.display = 'none';

      try {
        const response = await fetch('/api/ai/design', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt: prompt,
            cloud_provider: provider
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          alert(errorData.error || 'Failed to generate design');
          return;
        }

        // Stream the response
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullText = '';

        while (true) {
          const { done, value } = await reader.read();

          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');

          // Keep the last incomplete line in buffer
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);

              if (data === '[DONE]') {
                // Stream complete - try to parse the full JSON
                try {
                  // Extract JSON from markdown code blocks if present
                  let jsonText = fullText;

                  // Remove markdown code blocks (```json ... ```)
                  const codeBlockMatch = jsonText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                  if (codeBlockMatch) {
                    jsonText = codeBlockMatch[1];
                  }

                  currentAIDesign = JSON.parse(jsonText.trim());
                  contentPre.textContent = JSON.stringify(currentAIDesign, null, 2);

                  console.log('Parsed AI design:', currentAIDesign);

                  // Show apply button if design is valid
                  if (applyBtn && currentAIDesign.resources && currentAIDesign.resources.length > 0) {
                    applyBtn.style.display = 'inline-block';
                    console.log('Apply button shown - resources found:', currentAIDesign.resources.length);
                  } else {
                    console.log('Apply button hidden - no resources found');
                  }
                } catch (e) {
                  console.error('Failed to parse AI design:', e);
                  console.log('Raw text:', fullText.substring(0, 500));
                  contentPre.textContent = fullText;

                  // Try to show apply button anyway if we can manually parse
                  if (applyBtn && fullText.includes('"resources"')) {
                    applyBtn.style.display = 'inline-block';
                  }
                }
                break;
              }

              try {
                const chunk = JSON.parse(data);

                if (chunk.error) {
                  alert('Error: ' + chunk.error);
                  break;
                }

                if (chunk.chunk) {
                  fullText += chunk.chunk;
                  contentPre.textContent = fullText;

                  // Auto-scroll to bottom
                  contentPre.scrollTop = contentPre.scrollHeight;
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            }
          }
        }
      } catch (error) {
        console.error('AI Design error:', error);
        alert('Error generating design. Please try again.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Design';
      }
    }

    function applyAIDesignToCanvas() {
      console.log('Apply to canvas called, currentAIDesign:', currentAIDesign);

      // Try to parse if we have raw text
      if (!currentAIDesign || !currentAIDesign.resources) {
        // Try to parse from the content
        const contentPre = document.getElementById('aiDesignContent');
        const rawText = contentPre.textContent;

        try {
          // Try to extract JSON
          let jsonText = rawText;
          const codeBlockMatch = jsonText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
          if (codeBlockMatch) {
            jsonText = codeBlockMatch[1];
          }
          currentAIDesign = JSON.parse(jsonText.trim());
          console.log('Parsed design from content:', currentAIDesign);
        } catch (e) {
          console.error('Cannot parse design:', e);
          alert('No valid design to apply. Please generate a design first.');
          return;
        }
      }

      if (!currentAIDesign.resources || currentAIDesign.resources.length === 0) {
        alert('Design has no resources to apply');
        return;
      }

      try {
        // Clear current canvas
        if (resources.length > 0) {
          if (!confirm('This will clear your current canvas. Continue?')) {
            return;
          }
        }

        resources = [];
        connections = [];
        positions = {};
        nextId = 1;

        console.log('Converting resources:', currentAIDesign.resources);

        // Convert AI resources to canvas format
        const resourceMap = {}; // Map resource names to IDs

        // Get actual canvas dimensions for proper boundary checking
        const canvas = document.getElementById('canvas');
        const canvasRect = canvas.getBoundingClientRect();
        const CANVAS_WIDTH = canvasRect.width;
        const RESOURCE_WIDTH = 200;
        const MARGIN = 50;
        const SPACING_X = 220; // Space between resources horizontally
        const SPACING_Y = 140; // Space between resources vertically
        
        let xOffset = MARGIN;
        let yOffset = MARGIN;
        let resourcesInRow = 0;
        const maxResourcesPerRow = Math.floor((CANVAS_WIDTH - MARGIN * 2) / SPACING_X);

        currentAIDesign.resources.forEach((aiResource, index) => {
          const id = nextId++;
          const resourceType = aiResource.type;

          console.log(`Processing resource ${index}:`, aiResource);

          // Find template to get default values
          let template = null;
          const resourceTemplates = getResourceTemplates();
          for (const category in resourceTemplates) {
            const found = resourceTemplates[category].find(t => t.type === resourceType);
            if (found) {
              template = found;
              break;
            }
          }

          // Create resource object with proper defaults
          const resource = {
            id: id,
            type: resourceType,
            name: aiResource.name || `resource-${id}`,
            displayName: aiResource.name ? aiResource.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : `Resource ${id}`,
            icon: template ? template.icon : 'üì¶',
            color: template ? template.color : '#gray',
            instanceType: template ? template.defaultInstance : '',
            volumeSize: template ? (template.defaultSize || 0) : 0,
            ami: resourceType === 'aws_instance' ? 'ami-04b3c39a8a1c62b76' : '',
            isData: false,
            isModule: false,
            moduleSource: '',
            moduleVersion: '',
            moduleVars: null,
            dataFilter: null
          };

          // Merge AI configuration properties - overwrite defaults
          if (aiResource.configuration) {
            Object.assign(resource, aiResource.configuration);
          }

          resources.push(resource);
          resourceMap[aiResource.name] = id;

          // Position resources with proper boundary checking
          positions[id] = { x: xOffset, y: yOffset };
          console.log(`Positioned resource ${aiResource.name} at (${xOffset}, ${yOffset})`);

          // Layout resources in a grid with proper boundary checking
          resourcesInRow++;
          xOffset += SPACING_X;
          
          // Move to next row if we've hit the limit or would exceed canvas width
          if (resourcesInRow >= maxResourcesPerRow || xOffset + RESOURCE_WIDTH > CANVAS_WIDTH - MARGIN) {
            resourcesInRow = 0;
            xOffset = MARGIN;
            yOffset += SPACING_Y;
          }
        });

        console.log('Created resources:', resources);
        console.log('Resource map (name -> ID):', resourceMap);
        console.log('All positions:', positions);

        // Add connections if defined
        if (currentAIDesign.connections && currentAIDesign.connections.length > 0) {
          console.log('AI suggested connections:', currentAIDesign.connections);

          currentAIDesign.connections.forEach((conn, idx) => {
            const fromId = resourceMap[conn.from];
            const toId = resourceMap[conn.to];

            console.log(`Connection ${idx}: ${conn.from} (ID: ${fromId}) -> ${conn.to} (ID: ${toId})`);

            if (fromId && toId) {
              connections.push({
                from: fromId,
                to: toId
              });
            } else {
              console.warn(`Failed to create connection - fromId: ${fromId}, toId: ${toId}`);
              console.warn(`Available resource names:`, Object.keys(resourceMap));
            }
          });
          console.log('Created connections:', connections);
        } else {
          console.log('No connections in AI design');
        }

        // Update UI - use the correct function name
        updateUI();

        // Scroll canvas viewport to top-left to show resources
        const viewport = document.querySelector('.canvas-viewport');
        if (viewport) {
          viewport.scrollTop = 0;
          viewport.scrollLeft = 0;
          console.log('Reset viewport scroll to (0, 0)');
        }

        // Close modal
        closeAIDesignerModal();

        alert(`‚úì Applied ${resources.length} resources to canvas!`);
      } catch (error) {
        console.error('Error applying design:', error);
        alert('Failed to apply design to canvas: ' + error.message);
      }
    }

    // Cost Optimization Functions
    function showCostOptimization() {
      const modal = document.getElementById('costOptimizationModal');
      modal.style.display = 'flex';

      // Reset display states
      document.getElementById('costAnalysisLoading').style.display = 'none';
      document.getElementById('costAnalysisResult').style.display = 'none';
      document.getElementById('costOptimizationContent').textContent = '';
    }

    function closeCostOptimizationModal() {
      document.getElementById('costOptimizationModal').style.display = 'none';
    }

    async function analyzeCosts() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        alert('Please log in to use AI features');
        return;
      }

      if (resources.length === 0) {
        alert('Please add some resources to your infrastructure before analyzing costs');
        return;
      }

      // Show the modal
      showCostOptimization();

      // Show loading state
      document.getElementById('costAnalysisLoading').style.display = 'block';
      document.getElementById('costAnalysisResult').style.display = 'none';

      try {
        // Calculate current cost
        const currentCost = calculateTotalCost();

        const response = await fetch('/api/ai/cost-optimization', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            resources: resources,
            current_cost: currentCost
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to analyze costs');
        }

        // Hide loading, show results
        document.getElementById('costAnalysisLoading').style.display = 'none';
        document.getElementById('costAnalysisResult').style.display = 'block';

        // Update cost display
        document.getElementById('currentCost').textContent = `$${currentCost.toFixed(2)}`;
        document.getElementById('resourceCount').textContent = resources.length;

        // Clear previous content
        const contentDiv = document.getElementById('costOptimizationContent');
        contentDiv.textContent = '';

        // Handle streaming response
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') {
                console.log('Cost optimization streaming complete');
                break;
              }

              try {
                const parsed = JSON.parse(data);
                if (parsed.error) {
                  throw new Error(parsed.error);
                } else if (parsed.chunk) {
                  // Append streaming text
                  contentDiv.textContent += parsed.chunk;
                }
              } catch (e) {
                console.error('Error parsing stream data:', e);
              }
            }
          }
        }

      } catch (error) {
        console.error('Cost optimization error:', error);
        console.error('Error details:', error.message, error.stack);
        document.getElementById('costAnalysisLoading').style.display = 'none';
        alert(`Error analyzing costs: ${error.message}. Please try again.`);
        closeCostOptimizationModal();
      }
    }

    // Check URL for project ID and show save/load buttons
    function initProjectFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('project');

      if (projectId) {
        currentProjectId = projectId;
        document.getElementById('saveBtn').style.display = 'inline-block';
        document.getElementById('loadBtn').style.display = 'inline-block';
        document.getElementById('versionsBtn').style.display = 'inline-block';

        // Auto-load project state
        loadProjectState();
      }
    }

    // Start the app
    init();
    initProjectFromURL();
  </script>
</body>
</html>
